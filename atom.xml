<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>DreaceのBlog</title>
  
  <subtitle>幻冰の博客</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.dreace.top/"/>
  <updated>2023-01-10T14:30:55.295Z</updated>
  <id>https://blog.dreace.top/</id>
  
  <author>
    <name>Dreace</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>新冠病毒（COVID-19）感染记录</title>
    <link href="https://blog.dreace.top/2023/COVID-19-Infection-Record/"/>
    <id>https://blog.dreace.top/2023/COVID-19-Infection-Record/</id>
    <published>2023-01-09T15:21:59.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p>女朋友 12 月 24 日开始发烧，最高 39.1℃，24 日抗原阳性，吃了 3 次布洛芬缓释胶囊后体温稳定正常，但咳嗽和流涕症状依旧。</p><p>我 26 日开始发烧，27 日抗原阳性。变成了两个病号相依为命，打招呼都是用咳嗽声。好在没有两个人同时发烧下不了床，勉强还能互相照顾。</p><a id="more"></a><h2 id="月-26-日">12 月 26 日</h2><p>抗原阴性，稍微低烧和喉咙干痛，晚上 12 点 37.8℃。</p><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/COVID-19-Infection-Record/IMG_4160.jpg" style="width:33.0%" alt><figcaption>12 月 26 日抗原</figcaption></figure><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/COVID-19-Infection-Record/IMG_4163.jpg" style="width:33.0%" alt><figcaption>12 月 26 日体温</figcaption></figure><h2 id="月-27-日">12 月 27 日</h2><p>从早上到晚上咽痛、流涕、头晕、无力和咳嗽逐渐加重。</p><p>上午持续低烧，午后体温升高，抗原阳性。感觉无法继续工作请了半天病假。</p><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/COVID-19-Infection-Record/IMG_4166.jpg" style="width:33.0%" alt><figcaption>12 月 27 日抗原</figcaption></figure><p>14 点左右吃了 1 颗布洛芬缓释胶囊卧床休息倒六点左右体温恢复到 36.5℃ 左右。</p><p>20 点左右体温继续升高，22 点半 38℃，11 点半 38.6℃。凌晨 2 点 39.1℃ 被热醒，又吃了1 颗布洛芬，换了薄被子继续睡觉。</p><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/COVID-19-Infection-Record/IMG_4170.jpg" style="width:33.0%" alt><figcaption>12 月 27 日体温 1</figcaption></figure><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/COVID-19-Infection-Record/IMG_4169.jpg" style="width:33.0%" alt><figcaption>12 月 27 日体温 2</figcaption></figure><h2 id="月-28-日">12 月 28 日</h2><p>8 点半起床体温暂时正常，前一天的症状依旧，说话时咳嗽和流涕会加重，咳嗽时会附加头痛。抗原阳性。继续请了 1 天病假。</p><p>10 点左右体温又开始升高，一直 37.5℃ 到 37.8℃ 低烧。完整开始眼睛痛，眼白有很多血丝。</p><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/COVID-19-Infection-Record/IMG_4172.jpg" style="width:33.0%" alt><figcaption>12 月 28 日体温</figcaption></figure><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/COVID-19-Infection-Record/IMG_4175.jpg" style="width:33.0%" alt><figcaption>12 月 28 日抗原</figcaption></figure><h2 id="月-29-日">12 月 29 日</h2><p>8 点半起床 37.6℃ 低烧，眼睛痛、咳嗽、流涕、头晕和头痛，吃了 1 颗布洛芬缓释片，躺了一上午盖薄被子也会经常被热醒。继续请 1 天病假。</p><p>中午吃过饭精神状态稍微恢复，洗了热水澡，勉强能做一些家务活。</p><p>到晚上基本退烧，咳嗽和流涕依旧。</p><h2 id="月-30-日">12 月 30 日</h2><p>咳嗽、流涕，开始居家办公。</p><h2 id="月-2-日">1 月 2 日</h2><p>抗原转阴。</p><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/COVID-19-Infection-Record/IMG_4194.jpg" style="width:33.0%" alt><figcaption>1 月 2 日抗原</figcaption></figure><h2 id="后记">后记</h2><p>至1 月 9 日无明显不适，有轻微流涕和咳嗽。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;女朋友 12 月 24 日开始发烧，最高 39.1℃，24 日抗原阳性，吃了 3 次布洛芬缓释胶囊后体温稳定正常，但咳嗽和流涕症状依旧。&lt;/p&gt;
&lt;p&gt;我 26 日开始发烧，27 日抗原阳性。变成了两个病号相依为命，打招呼都是用咳嗽声。好在没有两个人同时发烧下不了床，勉强还能互相照顾。&lt;/p&gt;
    
    </summary>
    
    
      <category term="生活" scheme="https://blog.dreace.top/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
      <category term="新冠" scheme="https://blog.dreace.top/tags/%E6%96%B0%E5%86%A0/"/>
    
      <category term="COVID-19" scheme="https://blog.dreace.top/tags/COVID-19/"/>
    
  </entry>
  
  <entry>
    <title>解决小米智能设备连接网络超时</title>
    <link href="https://blog.dreace.top/2022/Solve-Xiaomi-Smart-Device-Connection-Network-Timeout/"/>
    <id>https://blog.dreace.top/2022/Solve-Xiaomi-Smart-Device-Connection-Network-Timeout/</id>
    <published>2022-12-31T07:00:01.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p>最近买的小米显示器挂灯 1S 和空气净化器 4 Lite 用米家 App 初始化时都连接不上网络（提示网络连接超时），Aqara 空调伴侣 P3 又一直连接正常，翻查了很久资料加上摸索终于解决。</p><a id="more"></a><h2 id="软硬件">软硬件</h2><ul><li>手机：iPhone 12（iOS 16.1）</li><li>路由器：极路由 4（OpenWrt）2.4GHz + 5GHz 分开的信号</li></ul><h2 id="尝试路径">尝试路径</h2><p>智能设备基本都使用 2.4G WiFi，因此只需要调整 2.4G 的设置就行，不用去动 5G 的配置。</p><p>最开始 2.4G 的配置是：</p><ul><li>名字（SSID）没有非 ASCII 字符</li><li>N 模式</li><li>自动选择信道</li><li>20MHz</li><li>加密 WPA2/WPA3，算法自动</li></ul><p>尝试：</p><ol type="1"><li>模式改为 Legacy，没有用。随后恢复</li><li>勾选「允许使用旧的 802.11b 速率」，没有用。随后恢复</li><li>加密改为 WPA2，没有用。随后恢复</li><li>加密改为 WPA，可以连接</li><li>加密改为 WPA/WPA2，可以连接</li></ol><p>结论是修改只需要修改<strong>加密方式为 WPA/WPA2 或 WPA</strong> 即可正常连接小米的智能设备。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近买的小米显示器挂灯 1S 和空气净化器 4 Lite 用米家 App 初始化时都连接不上网络（提示网络连接超时），Aqara 空调伴侣 P3 又一直连接正常，翻查了很久资料加上摸索终于解决。&lt;/p&gt;
    
    </summary>
    
    
      <category term="生活" scheme="https://blog.dreace.top/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
      <category term="小米" scheme="https://blog.dreace.top/tags/%E5%B0%8F%E7%B1%B3/"/>
    
      <category term="智能家居" scheme="https://blog.dreace.top/tags/%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85/"/>
    
  </entry>
  
  <entry>
    <title>在 Python 中调用 C/C++ 共享库</title>
    <link href="https://blog.dreace.top/2022/Calling-C-C-Shared-Library-Libraries-in-Python/"/>
    <id>https://blog.dreace.top/2022/Calling-C-C-Shared-Library-Libraries-in-Python/</id>
    <published>2022-04-17T11:36:34.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p>由于 Python 自身的特性（脚本语言、动态类型等）在性能和效率方面不是很理想，如果想在 Python 获得更高的运行性能可以通过调用 C/C++ 编写的共享库实现。</p><a id="more"></a><h2 id="前言">前言</h2><p>使用 C/C++ 编写的程序可以编译为共享库（Shared Library，Linux 中后缀为 <code>.so</code>）供其他程序在运行时加载并使用，Python 的标准库 <code>ctypes</code> 实现了加载、函数寻址、函数调用等方法可以方便地使用共享库<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。</p><h2 id="生成共享库">生成共享库</h2><p>假设有如下 C++ 代码实现了 64 位整型的加法和乘法、截取子字符串，以及一个名叫 <code>Point</code> 的结构体有 <code>x</code> 和 <code>y</code> 两个 32 位整型成员、两个 <code>Point*</code> 类型相加的函数。演示代码所以 <code>Substr</code> 函数实现偷懒了。</p><div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1"></a><span class="pp">#include </span><span class="im">&lt;cstdint&gt;</span></span><span id="cb1-2"><a href="#cb1-2"></a><span class="pp">#include </span><span class="im">&lt;string&gt;</span></span><span id="cb1-3"><a href="#cb1-3"></a></span><span id="cb1-4"><a href="#cb1-4"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> {</span><span id="cb1-5"><a href="#cb1-5"></a>    <span class="kw">typedef</span> <span class="kw">struct</span> Point {</span><span id="cb1-6"><a href="#cb1-6"></a>        <span class="dt">int32_t</span> x;</span><span id="cb1-7"><a href="#cb1-7"></a>        <span class="dt">int32_t</span> y;</span><span id="cb1-8"><a href="#cb1-8"></a>    } Point;</span><span id="cb1-9"><a href="#cb1-9"></a></span><span id="cb1-10"><a href="#cb1-10"></a>    Point PointAdd(Point* a, Point* b) {</span><span id="cb1-11"><a href="#cb1-11"></a>        Point result;</span><span id="cb1-12"><a href="#cb1-12"></a>        result.x = a -&gt; x + b -&gt; x;</span><span id="cb1-13"><a href="#cb1-13"></a>        result.y = a -&gt; y + b -&gt; y;</span><span id="cb1-14"><a href="#cb1-14"></a>        <span class="cf">return</span> result;</span><span id="cb1-15"><a href="#cb1-15"></a>    }</span><span id="cb1-16"><a href="#cb1-16"></a></span><span id="cb1-17"><a href="#cb1-17"></a>    <span class="dt">int64_t</span> Add(<span class="dt">int64_t</span> a, <span class="dt">int64_t</span> b) {</span><span id="cb1-18"><a href="#cb1-18"></a>        <span class="cf">return</span> a + b;</span><span id="cb1-19"><a href="#cb1-19"></a>    }</span><span id="cb1-20"><a href="#cb1-20"></a></span><span id="cb1-21"><a href="#cb1-21"></a>    <span class="dt">int64_t</span> Mul(<span class="dt">int64_t</span> a, <span class="dt">int64_t</span> b) {</span><span id="cb1-22"><a href="#cb1-22"></a>        <span class="cf">return</span> a * b;</span><span id="cb1-23"><a href="#cb1-23"></a>    }</span><span id="cb1-24"><a href="#cb1-24"></a></span><span id="cb1-25"><a href="#cb1-25"></a>    <span class="at">const</span> <span class="dt">char</span>* Substr(<span class="dt">char</span>* str, <span class="dt">int64_t</span> start, <span class="dt">int64_t</span> length) {</span><span id="cb1-26"><a href="#cb1-26"></a>        <span class="cf">return</span> <span class="bu">std::</span>string(str).substr(start, length).c_str();</span><span id="cb1-27"><a href="#cb1-27"></a>    }</span><span id="cb1-28"><a href="#cb1-28"></a>}</span></code></pre></div><p>假设源码文件名为 <code>functions.cpp</code>，使用 <code>g++</code> 编译上述代码生成共享库：</p><pre class="shell"><code>g++ -fPIC -shared -lstdc++ -o libfunctions.so functions.cpp</code></pre><p>参数含义：</p><ul><li><code>-fPIC</code>：生成地址无关代码，生成共享库时通常配合使用该参数，如果设置了该参数，宏<code>__pic__</code> 和 <code>__PIC__</code> 会被定义且值为 <code>2</code></li><li><code>-shared</code>：生成共享库，通常需要同时设置 <code>-fPIC</code></li><li><code>-lstdc++</code>：链接 C++ 标准库</li><li><code>-o</code>：指定输出文件，这里为 <code>libfunctions.so</code></li></ul><p><code>extern "C"</code> 告诉编译器在编译时 <code>{}</code> 中的函数名字需要与 C 兼容，详见 <a href="https://stackoverflow.com/questions/1041866/what-is-the-effect-of-extern-c-in-c" target="_blank" rel="noopener">What is the effect of extern "C" in C++? - Stack Overflow</a>。</p><h2 id="python-中使用共享库">Python 中使用共享库</h2><p>Python 中导入 <code>ctypes</code> 指定共享库（<code>.so</code> 文件）加载后声明函数的参数列表和返回值类型（基础类型可声明返回值类型）即可调用共享库中的函数。</p><h3 id="简单函数">简单函数</h3><p>以调用 <code>Add</code> 函数为例：</p><div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="im">import</span> ctypes</span><span id="cb3-2"><a href="#cb3-2"></a></span><span id="cb3-3"><a href="#cb3-3"></a>functions <span class="op">=</span> ctypes.CDLL(<span class="st">&quot;./libfunctions.so&quot;</span>)</span><span id="cb3-4"><a href="#cb3-4"></a></span><span id="cb3-5"><a href="#cb3-5"></a>functions.Add.argtypes <span class="op">=</span> [ctypes.c_int64, ctypes.c_int64]</span><span id="cb3-6"><a href="#cb3-6"></a><span class="bu">print</span>(functions.Add(<span class="dv">1</span>, <span class="dv">2</span>))</span></code></pre></div><p>其中 <code>argtypes</code> 声明了 <code>Add</code> 函数的参数列表：两个 <code>int64</code> 参数，执行 Python 文件就可以得到结果 <code>3</code>。</p><p>调用 <code>Mul</code> 函数也是类似的：</p><div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a>functions.Mul.argtypes <span class="op">=</span> [ctypes.c_int64, ctypes.c_int64]</span><span id="cb4-2"><a href="#cb4-2"></a><span class="bu">print</span>(functions.Mul(<span class="dv">233</span>, <span class="dv">2</span>))</span></code></pre></div><p>可以得到结果 <code>466</code>。</p><h3 id="非基础类型参数">非基础类型参数</h3><p><code>Substr</code> 的第一个参数是字符指针（<code>char*</code>）因此第一个参数应该使用 <code>c_char_p</code>，同时返回值也是字符指针而不是基础类型因此需要声明返回值类型：</p><div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a>functions.Substr.argtypes <span class="op">=</span> [ctypes.c_char_p, ctypes.c_int64, ctypes.c_int64]</span><span id="cb5-2"><a href="#cb5-2"></a>functions.Substr.restype <span class="op">=</span> ctypes.c_char_p</span><span id="cb5-3"><a href="#cb5-3"></a></span><span id="cb5-4"><a href="#cb5-4"></a><span class="bu">print</span>(functions.Substr(ctypes.c_char_p(<span class="st">&quot;Hello World&quot;</span>.encode()), <span class="dv">2</span>, <span class="dv">5</span>).decode())</span></code></pre></div><p>构造 <code>c_char_p</code> 时可以使用 <code>bytes</code> 或者 <code>int</code>（指针），这里直接将字符串编码传入，执行得到结果 <code>llo W</code>。</p><h3 id="使用结构体">使用结构体</h3><p>在 Python 中定义结构体后可以将结构体作为参数传递给共享库中的函数：</p><div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">class</span> Point(ctypes.Structure):</span><span id="cb6-2"><a href="#cb6-2"></a>    _fields_ <span class="op">=</span> [(<span class="st">&quot;x&quot;</span>, ctypes.c_int32), (<span class="st">&quot;y&quot;</span>, ctypes.c_int32)]</span></code></pre></div><p>定义 <code>Point</code> 结构体，有两个名为 <code>x</code> 和 <code>y</code>，类型是 <code>int32</code> 的参数，然后声明 <code>PointAdd</code> 函数：</p><div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>PointAdd <span class="op">=</span> functions.PointAdd</span><span id="cb7-2"><a href="#cb7-2"></a>PointAdd.argtypes <span class="op">=</span> [ctypes.POINTER(Point), ctypes.POINTER(Point)]</span><span id="cb7-3"><a href="#cb7-3"></a>PointAdd.restype <span class="op">=</span> Point</span></code></pre></div><p>构造两个 <code>Point</code> 结构体调用 <code>PointAdd</code> 函数：</p><div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a>p_a <span class="op">=</span> Point(<span class="dv">1</span>, <span class="dv">2</span>)</span><span id="cb8-2"><a href="#cb8-2"></a>p_b <span class="op">=</span> Point(<span class="dv">3</span>, <span class="dv">4</span>)</span><span id="cb8-3"><a href="#cb8-3"></a></span><span id="cb8-4"><a href="#cb8-4"></a>p_result <span class="op">=</span> PointAdd(p_a, p_b)</span><span id="cb8-5"><a href="#cb8-5"></a></span><span id="cb8-6"><a href="#cb8-6"></a><span class="bu">print</span>(p_result.x, p_result.y)</span></code></pre></div><p>执行得到结果 <code>4 6</code>。</p><h2 id="使用-cmake">使用 CMake</h2><p>假设目录结构如下 ：</p><pre class="plain"><code>.├── CMakeLists.txt├── include│   └── point.h└── src    └── functions.cpp</code></pre><p><code>include</code> 存放项目头文件，<code>src</code> 存放源文件，<code>point.h</code> 中是 <code>Point</code> 结构体定义：</p><div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1"></a><span class="pp">#include </span><span class="im">&lt;cstdint&gt;</span></span><span id="cb10-2"><a href="#cb10-2"></a></span><span id="cb10-3"><a href="#cb10-3"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> {</span><span id="cb10-4"><a href="#cb10-4"></a>    <span class="kw">typedef</span> <span class="kw">struct</span> Point {</span><span id="cb10-5"><a href="#cb10-5"></a>        <span class="dt">int32_t</span> x;</span><span id="cb10-6"><a href="#cb10-6"></a>        <span class="dt">int32_t</span> y;</span><span id="cb10-7"><a href="#cb10-7"></a>    } Point;</span><span id="cb10-8"><a href="#cb10-8"></a>}</span></code></pre></div><p><code>functions.cpp</code> 除移动到 <code>point.h</code> 中内的容外不变，最小化 <code>CMakeLists.txt</code> 文件：</p><div class="sourceCode" id="cb11"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">cmake_minimum_required</span>(<span class="ot">VERSION</span> 2.8.9)</span><span id="cb11-2"><a href="#cb11-2"></a><span class="kw">project</span> (Functions)</span><span id="cb11-3"><a href="#cb11-3"></a><span class="kw">set</span>(<span class="dv">CMAKE_CXX_STANDARD</span> 11)</span><span id="cb11-4"><a href="#cb11-4"></a></span><span id="cb11-5"><a href="#cb11-5"></a><span class="kw">include</span>_directories(./include)</span><span id="cb11-6"><a href="#cb11-6"></a><span class="kw">aux_source_directory</span>(./src DIR_SRCS)</span><span id="cb11-7"><a href="#cb11-7"></a></span><span id="cb11-8"><a href="#cb11-8"></a><span class="kw">add_library</span>(Functions <span class="ot">SHARED</span> <span class="dv">${</span>DIR_SRCS<span class="dv">}</span>)</span></code></pre></div><p>编译后修改 Python 中的 <code>functions = ctypes.CDLL("./libfunctions.so")</code> 路径为新的 <code>.so</code> 路径即可使用。</p><section class="footnotes" role="doc-endnotes"><hr><ol><li id="fn1" role="doc-endnote"><p><a href="https://docs.python.org/zh-cn/3/library/ctypes.html" target="_blank" rel="noopener">https://docs.python.org/zh-cn/3/library/ctypes.html</a> "ctypes --- Python 的外部函数库 — Python 3.10.4 文档"<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li></ol></section>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;由于 Python 自身的特性（脚本语言、动态类型等）在性能和效率方面不是很理想，如果想在 Python 获得更高的运行性能可以通过调用 C/C++ 编写的共享库实现。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python" scheme="https://blog.dreace.top/categories/Python/"/>
    
    
      <category term="C/C++" scheme="https://blog.dreace.top/tags/C-C/"/>
    
      <category term="Python" scheme="https://blog.dreace.top/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>疫情期间在深圳办理港澳通行证并签注</title>
    <link href="https://blog.dreace.top/2021/Apply-for-a-EEP-in-Shenzhen-During-the-Epidemic/"/>
    <id>https://blog.dreace.top/2021/Apply-for-a-EEP-in-Shenzhen-During-the-Epidemic/</id>
    <published>2021-12-03T11:30:00.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p>目前（2021 年 12 月 03 日）如果持有有效签注的港澳通行证可以前往澳门旅游，因此想办个通行证去澳门玩一圈，写下本文记录办证过程。</p><a id="more"></a><h2 id="更新记录">更新记录</h2><ol type="1"><li>2021-12-03：首次发布</li></ol><h2 id="情况概述">情况概述</h2><p>本文适用于在深圳工作的非深户人员办理港澳通行证及签注（深户办理更简单，部分流程可跳过）。</p><h2 id="办理港澳通行证">办理港澳通行证</h2><h3 id="网上预约">网上预约</h3><ol type="1"><li>进入「深圳公安」公众号</li><li>选择底部「政务服务」，并选择「出入境业务」</li><li>在「窗口业务预约办理」分类下选择「深圳户籍」或「非深圳户籍」</li><li>选择「首次办理来往港澳通行证」</li><li>就近选择「服务大厅」和「预约时间」</li><li>填写个人信息和办证类型</li></ol><p>注意：</p><ol type="1"><li>深户或非深户有居住证可以选择办理通行证时同时办理旅游签注</li><li>非深户无居住证只能办理白证或商务签注</li><li>以上为疫情期间限制，可能随时发生变化</li></ol><h3 id="现场办理">现场办理</h3><h4 id="需要准备的证件">需要准备的证件</h4><ol type="1"><li>本人身份证原件</li><li>亲属身份证号码（父母、子女）</li><li>照片回执（可现场拍摄或使用已有回执）</li></ol><p>注意：</p><ol type="1"><li>现场机器可能会出现问题无法拍摄，可多尝试几次</li><li>如果使用已有回执注意有效期及提前打印好</li></ol><h4 id="办理流程">办理流程</h4><ol type="1"><li>到达预约的出入境大厅后将签字的回执和身份证交给业务员，拿到一个申请表格</li><li>填写表格后交回审核拿到排队号码</li><li>等待叫号后确认信息签字办理</li><li>缴纳工本费（如果同时签注还需缴纳签注费用）</li><li>选择到现场领取还是邮件证件</li><li>等待领取证件</li></ol><p>注意：</p><ol type="1"><li>一般工本费 60 元，签注 15 元一次</li><li>邮寄为到付</li><li>深户办证市场为十天左右、非深户二十天左右</li></ol><h2 id="非深户办理签注">非深户办理签注</h2><p>非深户如果在疫情期间办理澳门旅游签注必须先办理居住证，目前办理居住证有主要两个渠道：</p><ol type="1"><li>社保已连续缴纳十二个月或前两年缴纳超过十八个月可以直接办理</li><li>全日制大专及以上学历在人社局认证后可直接办理</li><li>白证不到五个工作日邮寄拿到（个人体验）</li></ol><h3 id="人社局认证学历">人社局认证学历</h3><p>已满足条件一可直接办理居住证。</p><h4 id="需要准备的资料">需要准备的资料</h4><ol type="1"><li>身份证正反面电子扫描件</li><li>《毕业证》电子扫描件</li><li><a href="https://my.chsi.com.cn/archive/index.jsp" target="_blank" rel="noopener">学信网</a> 的《教育部学历证书电子注册备案表》</li></ol><p>注意：</p><ol type="1"><li>文件可以为 JPG 或 PDF</li><li>单个文件大小不能超过 300KiB</li></ol><h4 id="网上办理">网上办理</h4><ol type="1"><li>进入 <a href="https://hrsspub.sz.gov.cn/rcyj/login_unit.jsp" target="_blank" rel="noopener">人才引进业务申报系统</a></li><li>选择「个人用户登录」下的「省政务服务网认证入口」后使用「微信」扫码登录</li><li>左侧选择「申办居住证人员核实学历」</li><li>跳转后选择「申报居住证学历认定」并同意《承诺书》</li><li>填写基本信息和上传必要的证件</li><li>获取手机验证码后提交</li><li>等待认证结果</li></ol><p>注意：</p><ol type="1"><li>申报的网站响应较慢，需要耐心等待</li><li>认证等待时间在十分钟左右（个人体验）</li><li>申报状态变为「审核同意」即为成功</li></ol><h3 id="办理居住证">办理居住证</h3><ol type="1"><li>进入「深圳公安」公众号</li><li>选择底部「政务服务」，并选择「户政业务」</li><li>选择「深圳经济特区居住证申领」</li><li>直接点击「下一步」</li><li>申办条件选择「人才引进-全日制大专及以上学历人员」</li><li>领取方式选择「邮政速递」</li><li>填写个人信息</li><li>点击「下一步」完成申请</li></ol><p>注意：</p><ol type="1"><li>如果选择「邮政速递」邮费为到付</li><li>照片回执可以通过支付宝、微信小程序拍摄，可多次使用</li></ol><h3 id="签注">签注</h3><p>由于疫情反复，出行计划暂时搁置，待更新。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;目前（2021 年 12 月 03 日）如果持有有效签注的港澳通行证可以前往澳门旅游，因此想办个通行证去澳门玩一圈，写下本文记录办证过程。&lt;/p&gt;
    
    </summary>
    
    
      <category term="指南" scheme="https://blog.dreace.top/categories/%E6%8C%87%E5%8D%97/"/>
    
    
      <category term="深圳" scheme="https://blog.dreace.top/tags/%E6%B7%B1%E5%9C%B3/"/>
    
      <category term="玩" scheme="https://blog.dreace.top/tags/%E7%8E%A9/"/>
    
  </entry>
  
  <entry>
    <title>微星主板 boot 灯常亮</title>
    <link href="https://blog.dreace.top/2021/MSI-Motherboard-Boot-Light-Is-On/"/>
    <id>https://blog.dreace.top/2021/MSI-Motherboard-Boot-Light-Is-On/</id>
    <published>2021-07-03T07:19:00.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p>周五，本应该是一个美好的时间，但如果按下电脑开机键屏幕却没有点亮将会感受到整个世界的恶意。</p><a id="more"></a><h2 id="背景">背景</h2><p>周五下班回家后开电脑发现屏幕一直没有反应，拔插 DP 线也没有效果，并且发现主板的 boot 灯一直亮着，说明在启动中但是没有成功。开关几次电源还是没有效果后开始慌了。</p><h2 id="尝试解决">尝试解决</h2><h3 id="拔插显卡">拔插显卡</h3><p>显卡是刚买的 RX 6900 XT，在默默祈祷中拆下面板把显卡取下来再插回去，但是通电后依然没有效果，显示器依旧提示没有信号输入。</p><h3 id="更换显卡">更换显卡</h3><p>查阅资料后没有获得有效信息，但想起来之前用的亮机卡（750 Ti）还在，就换上了试试。</p><p>换上 750 Ti 显示器有信号了，提示内存超频失败（内存是芝奇皇家戟 8Gx4，自动超频到 3600），这下问题找到了，进入 BIOS 禁用 XMP，然后重启，成功进入系统。</p><p>此后多次尝试重启系统均成功，然后将显卡换回 RX 6900 XT 也成功启动。</p><h2 id="总结">总结</h2><p>原因未知，但是旧显卡留着还是有用的。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;周五，本应该是一个美好的时间，但如果按下电脑开机键屏幕却没有点亮将会感受到整个世界的恶意。&lt;/p&gt;
    
    </summary>
    
    
      <category term="装机" scheme="https://blog.dreace.top/categories/%E8%A3%85%E6%9C%BA/"/>
    
    
      <category term="装机" scheme="https://blog.dreace.top/tags/%E8%A3%85%E6%9C%BA/"/>
    
      <category term="电脑" scheme="https://blog.dreace.top/tags/%E7%94%B5%E8%84%91/"/>
    
      <category term="启动" scheme="https://blog.dreace.top/tags/%E5%90%AF%E5%8A%A8/"/>
    
  </entry>
  
  <entry>
    <title>神策数据后端研发面经</title>
    <link href="https://blog.dreace.top/2020/SENSORS-Data-Back-End-Interview-Experience/"/>
    <id>https://blog.dreace.top/2020/SENSORS-Data-Back-End-Interview-Experience/</id>
    <published>2020-09-08T14:03:32.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p><del>一二面完成，等待后续通知。</del></p><p>2020年9月28日更新：已拿到意向书。</p><a id="more"></a><h2 id="第-1-面">第 1 面</h2><ol type="1"><li>自我介绍</li><li>项目相关<ol type="1"><li>解决的最困难的问题</li></ol></li><li>算法：数组中出现次数最多的数字</li><li>算法：字典树</li><li>Python 中元组和列表</li><li>Python 中判断对象是否为某个类的实例</li><li>Python 中 with</li><li>全局解释器锁</li><li>Python 值传递和引用传递</li><li>如何实现一个队列</li><li>平衡二叉树和普通二叉树的区别</li><li>B+ 树</li><li>进程间通信方式</li><li>TCP 和 UDP 区别</li><li>HTTP 状态码</li></ol><h2 id="第-2-面">第 2 面</h2><ol type="1"><li>自我介绍</li><li>项目相关</li><li>算法：给定权限字符串"[1, 2, 3]" 表示白名单，"[1, 2, 3]" 表示黑名单，给定一个 ID，判断是否拥有权限</li><li>C++ 中 <code>char*</code> 和 <code>string</code></li><li>Python 中生成器</li><li>Python 中装饰器<ol type="1"><li>手写一个装饰器</li></ol></li><li>Python 中列表和元组<ol type="1"><li>什么情况可以使用元组，但是不能使用列表</li></ol></li><li>Python 中值传递和引用传递</li><li>反问</li></ol><h2 id="第-3-面cto-面">第 3 面（CTO 面）</h2><p>从二面结束到三面差不多过了一个月，三面是去北京线下面试。</p><ol type="1"><li>智力题：有四瓶药，其中三瓶 A 药每粒重 3g，一瓶 B 药每粒重 4g，一个电子秤称一次找出哪个是 B 药</li><li>开放性问题：估计一栋二十层楼房的重量</li><li>真·手撕代码：链表反转</li><li>反问</li></ol><p>整个CTO 面试流程很快，体验也很好。结束之后 HR 又来问了一些常规的问题，然后带着去看了一下公司的技术办公区。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;del&gt;一二面完成，等待后续通知。&lt;/del&gt;&lt;/p&gt;
&lt;p&gt;2020年9月28日更新：已拿到意向书。&lt;/p&gt;
    
    </summary>
    
    
      <category term="面经" scheme="https://blog.dreace.top/categories/%E9%9D%A2%E7%BB%8F/"/>
    
    
      <category term="面经" scheme="https://blog.dreace.top/tags/%E9%9D%A2%E7%BB%8F/"/>
    
      <category term="神策数据" scheme="https://blog.dreace.top/tags/%E7%A5%9E%E7%AD%96%E6%95%B0%E6%8D%AE/"/>
    
  </entry>
  
  <entry>
    <title>C/C++ 编码规范</title>
    <link href="https://blog.dreace.top/2020/C-C-Coding-Standards/"/>
    <id>https://blog.dreace.top/2020/C-C-Coding-Standards/</id>
    <published>2020-08-27T12:25:24.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p>规范的编码能增强代码的可读性，提升 debug 效率。良好的代码规范还能提升团队间的协作效率，起码别人不用费心去研究表达式的含义。</p><a id="more"></a><h2 id="一个例子">一个例子</h2><h3 id="反面教材">反面教材</h3><div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1"></a><span class="cf">for</span> (<span class="dt">int</span> i = n; i &gt;= <span class="dv">0</span>; i--) {</span><span id="cb1-2"><a href="#cb1-2"></a><span class="dt">int</span> d = pos - stop[i].f;</span><span id="cb1-3"><a href="#cb1-3"></a><span class="cf">while</span> (tank - d &lt; <span class="dv">0</span>)</span><span id="cb1-4"><a href="#cb1-4"></a>{<span class="cf">if</span> (que.empty()) {</span><span id="cb1-5"><a href="#cb1-5"></a>puts(<span class="st">&quot;-1&quot;</span>);</span><span id="cb1-6"><a href="#cb1-6"></a><span class="cf">return</span> <span class="dv">0</span>;</span><span id="cb1-7"><a href="#cb1-7"></a>}</span><span id="cb1-8"><a href="#cb1-8"></a>tank += que.top();</span><span id="cb1-9"><a href="#cb1-9"></a>que.pop();ans++;}</span><span id="cb1-10"><a href="#cb1-10"></a>tank -= d;pos = stop[i].f;</span><span id="cb1-11"><a href="#cb1-11"></a>que.push(stop[i].s);</span><span id="cb1-12"><a href="#cb1-12"></a>}</span></code></pre></div><p>完全看不清这段代码在干什么，作用域尤其不清楚，如果看到上千行这样的代码会直接崩溃。</p><h3 id="正面例子">正面例子</h3><p>那么格式化后，是这样的：</p><div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1"></a><span class="cf">for</span> (<span class="dt">int</span> i = n; i &gt;= <span class="dv">0</span>; --i) {</span><span id="cb2-2"><a href="#cb2-2"></a>    <span class="dt">int</span> d = pos - stop[i].f;</span><span id="cb2-3"><a href="#cb2-3"></a>    <span class="cf">while</span> (tank - d &lt; <span class="dv">0</span>) {</span><span id="cb2-4"><a href="#cb2-4"></a>        <span class="cf">if</span> (que.empty()) {</span><span id="cb2-5"><a href="#cb2-5"></a>            puts(<span class="st">&quot;-1&quot;</span>);</span><span id="cb2-6"><a href="#cb2-6"></a>            <span class="cf">return</span> <span class="dv">0</span>;</span><span id="cb2-7"><a href="#cb2-7"></a>        }</span><span id="cb2-8"><a href="#cb2-8"></a>        tank += que.top();</span><span id="cb2-9"><a href="#cb2-9"></a>        que.pop();</span><span id="cb2-10"><a href="#cb2-10"></a>        ++ans;</span><span id="cb2-11"><a href="#cb2-11"></a>    }</span><span id="cb2-12"><a href="#cb2-12"></a>    tank -= d;</span><span id="cb2-13"><a href="#cb2-13"></a>    pos = stop[i].f;</span><span id="cb2-14"><a href="#cb2-14"></a>    que.push(stop[i].s);</span><span id="cb2-15"><a href="#cb2-15"></a>}</span></code></pre></div><p>代码含义一下子就明了了 。</p><h2 id="编码原则">编码原则</h2><ul><li>增加代码可读性</li><li>避免混淆</li><li>保持代码风格一致</li></ul><h3 id="关于注释">关于注释</h3><p>尽量使用单行注释 <code>// ...</code> 而不是多行注释 <code>/* ... */</code>，因为在大多数时候可以使用 IDE 快捷键 <code>Ctrl + /</code> 可以添加或取消单行注释，并且 <code>//</code> 后要添加空格，不同行的注释需要对齐，为函数和控制语句添加注释时，可以将注释放在上一行，例如：</p><div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1"></a><span class="cf">for</span> (<span class="dt">int</span> i = n; i &gt;= <span class="dv">0</span>; --i) {</span><span id="cb3-2"><a href="#cb3-2"></a>    <span class="dt">int</span> d = pos - stop[i].f;</span><span id="cb3-3"><a href="#cb3-3"></a>    <span class="co">// 一个操作</span></span><span id="cb3-4"><a href="#cb3-4"></a>    <span class="cf">while</span> (tank - d &lt; <span class="dv">0</span>) {</span><span id="cb3-5"><a href="#cb3-5"></a>        <span class="co">// que 为空</span></span><span id="cb3-6"><a href="#cb3-6"></a>        <span class="cf">if</span> (que.empty()) {</span><span id="cb3-7"><a href="#cb3-7"></a>            puts(<span class="st">&quot;-1&quot;</span>); <span class="co">// 输出</span></span><span id="cb3-8"><a href="#cb3-8"></a>            <span class="cf">return</span> <span class="dv">0</span>;   <span class="co">// 返回</span></span><span id="cb3-9"><a href="#cb3-9"></a>        }</span><span id="cb3-10"><a href="#cb3-10"></a>        tank += que.top();  <span class="co">// 取栈顶元素</span></span><span id="cb3-11"><a href="#cb3-11"></a>        que.pop();          <span class="co">// 弹出栈顶</span></span><span id="cb3-12"><a href="#cb3-12"></a>        ++ans;              <span class="co">// 更新答案</span></span><span id="cb3-13"><a href="#cb3-13"></a>    }</span><span id="cb3-14"><a href="#cb3-14"></a>    tank -= d;</span><span id="cb3-15"><a href="#cb3-15"></a>    pos = stop[i].f;</span><span id="cb3-16"><a href="#cb3-16"></a>    que.push(stop[i].s);</span><span id="cb3-17"><a href="#cb3-17"></a>}</span></code></pre></div><h3 id="关于空行">关于空行</h3><p>头文件、宏定义与主要实现部分使用空行分开，如：</p><div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span><span id="cb4-2"><a href="#cb4-2"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span><span id="cb4-3"><a href="#cb4-3"></a></span><span id="cb4-4"><a href="#cb4-4"></a><span class="dt">bool</span> cmp(<span class="dt">int</span> a, <span class="dt">int</span> b){</span><span id="cb4-5"><a href="#cb4-5"></a>    <span class="co">//Do something here</span></span><span id="cb4-6"><a href="#cb4-6"></a>}</span></code></pre></div><p>同一个函数不同功能代码间使用空行分开。</p><h3 id="关于空格">关于空格</h3><p>在赋值运算符、逻辑运算符、位运算符、算术运算符前后添加空格，例如 <code>name = "Alice"</code> 不能写成 <code>name="Alice"</code>。</p><p>在引用操作符 <code>.</code>、<code>-&gt;</code>、<code>[]</code> 前后不能添加空格。</p><p>添加空格的目的是让独立的 token 分开，加快阅读代码的速度。</p><h3 id="关于缩进">关于缩进</h3><p>按照代码逻辑水平缩进，缩进时使用 Tab 或四个 Space 或两个 Space 作为一个缩进单位，全局保持一致即可。 左大括号 <code>{</code> 使用 Java 风格，即放在上一行末，在前一个字符和 <code>{</code> 之间添加一个空格，也可选择左大括号放在新行，全局保持一致即可。</p><p>平行逻辑代码列对齐，子逻辑与上层逻辑有一个单位的缩进，例如：</p><div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1"></a><span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; n; ++i) {</span><span id="cb5-2"><a href="#cb5-2"></a>    scanf(<span class="st">&quot;</span><span class="sc">%s</span><span class="st">&quot;</span>, field[i]);</span><span id="cb5-3"><a href="#cb5-3"></a>}</span><span id="cb5-4"><a href="#cb5-4"></a><span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; n; ++j) {</span><span id="cb5-5"><a href="#cb5-5"></a>    <span class="cf">for</span> (<span class="dt">int</span> j = <span class="dv">0</span>; j &lt; m; ++j) {</span><span id="cb5-6"><a href="#cb5-6"></a>        <span class="cf">if</span> (field[i][j] == <span class="ch">&#39;W&#39;</span>) {</span><span id="cb5-7"><a href="#cb5-7"></a>            dfs(i, j);</span><span id="cb5-8"><a href="#cb5-8"></a>            ++count;</span><span id="cb5-9"><a href="#cb5-9"></a>        }</span><span id="cb5-10"><a href="#cb5-10"></a>    }</span><span id="cb5-11"><a href="#cb5-11"></a>}</span></code></pre></div><h3 id="关于控制语句">关于控制语句</h3><p>无论控制语句有几行都要用使用 <code>{</code>、<code>}</code> 括起来，例如：</p><div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1"></a><span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; n; ++i) {</span><span id="cb6-2"><a href="#cb6-2"></a>    ++x;</span><span id="cb6-3"><a href="#cb6-3"></a>}</span><span id="cb6-4"><a href="#cb6-4"></a><span class="cf">if</span> (!s.empty()) {</span><span id="cb6-5"><a href="#cb6-5"></a>    res = <span class="dv">1</span>;</span><span id="cb6-6"><a href="#cb6-6"></a>}</span></code></pre></div><p>不能写成：</p><div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1"></a><span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; n; ++i)</span><span id="cb7-2"><a href="#cb7-2"></a>    ++x;</span><span id="cb7-3"><a href="#cb7-3"></a><span class="cf">if</span> (!s.empty())</span><span id="cb7-4"><a href="#cb7-4"></a>    res = <span class="dv">1</span>;</span></code></pre></div><h3 id="一行只写一个语句">一行只写一个语句</h3><div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1"></a><span class="cf">while</span> (x != s) {</span><span id="cb8-2"><a href="#cb8-2"></a>    ++x;</span><span id="cb8-3"><a href="#cb8-3"></a>}</span></code></pre></div><p>不能写成：</p><div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1"></a><span class="cf">while</span> (x != s) { ++x; }</span></code></pre></div><p>或：</p><div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1"></a><span class="cf">while</span> (x != s) ++x;</span></code></pre></div><h3 id="命名">命名</h3><p><strong>不要使用拼音</strong>，尤其是拼音缩写，会给其他阅读代码的人带来困扰。</p><p>在命名时尽量使变量名表达出它的含义，不要过度使用缩写。在 <code>for</code> 循环控制中可以使用 <code>i</code>、<code>j</code>、<code>k</code> 等简短的变量，以减少键入的时间。</p><p>变量使用下划线分割，如 <code>list_name</code> 、 <code>lake_field</code>，当然也可以选择小驼峰命名风格 <code>listName</code> 、 <code>lakeField</code>，或者其他自己喜欢的风格。</p><p>常量、宏定义使用全大写，如 <code>const int MAX = 100;</code> <code>#define MAXN 100005</code>。</p><p>函数名使用小驼峰命名，如 <code>string getStudentNumber(...)</code>、<code>int maxOfTree(...)</code>。</p><p><strong>强烈建议</strong>类名使用大驼峰命名，如 <code>class Solution{...};</code>。</p><h3 id="不建议的操作">不建议的操作</h3><p>编码时<strong>不建议</strong>使用第一眼看不出含义的特性，即使该特性是合法的。</p><p>不要这样写：</p><div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1"></a>a = b = <span class="dv">5</span>;</span><span id="cb11-2"><a href="#cb11-2"></a>c += d++;</span></code></pre></div><p>而是写成这样：</p><div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1"></a>a = <span class="dv">5</span>;</span><span id="cb12-2"><a href="#cb12-2"></a>b = <span class="dv">5</span>;</span><span id="cb12-3"><a href="#cb12-3"></a>++d;</span><span id="cb12-4"><a href="#cb12-4"></a>c += d;</span></code></pre></div><p>不要这样写：</p><div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1"></a><span class="cf">if</span> (m -= d) {</span><span id="cb13-2"><a href="#cb13-2"></a>    <span class="co">// Do something here</span></span><span id="cb13-3"><a href="#cb13-3"></a>}</span></code></pre></div><p>而是写成这样：</p><div class="sourceCode" id="cb14"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1"></a>m -= d;</span><span id="cb14-2"><a href="#cb14-2"></a><span class="cf">if</span> (m != <span class="dv">0</span>) {</span><span id="cb14-3"><a href="#cb14-3"></a>    <span class="co">// Do something here</span></span><span id="cb14-4"><a href="#cb14-4"></a>}</span></code></pre></div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;规范的编码能增强代码的可读性，提升 debug 效率。良好的代码规范还能提升团队间的协作效率，起码别人不用费心去研究表达式的含义。&lt;/p&gt;
    
    </summary>
    
    
      <category term="C/C++" scheme="https://blog.dreace.top/categories/C-C/"/>
    
    
      <category term="C/C++" scheme="https://blog.dreace.top/tags/C-C/"/>
    
      <category term="编码规范" scheme="https://blog.dreace.top/tags/%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83/"/>
    
  </entry>
  
  <entry>
    <title>美团后端开发凉经，共两面</title>
    <link href="https://blog.dreace.top/2020/Meituan-Back-End-Interview-Experience-a-Total-of-Two-Times/"/>
    <id>https://blog.dreace.top/2020/Meituan-Back-End-Interview-Experience-a-Total-of-Two-Times/</id>
    <published>2020-08-21T13:28:01.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p>美团面得快，凉得也快。</p><a id="more"></a><h2 id="第-1-面">第 1 面</h2><ol type="1"><li>自我介绍</li><li>项目模块划分</li><li>MySQL<ol type="1"><li>主从</li><li>隔离级别</li><li>日志</li><li>MVCC</li><li>如何评估 SQL 语句的性能</li><li>为什么选用 InnoDB</li></ol></li><li>B+ 树对比其他树结构的优点</li><li>Redis 为什么高效</li><li>Redis 持久化</li><li>算法：<a href="https://leetcode-cn.com/problems/zui-xiao-de-kge-shu-lcof/" target="_blank" rel="noopener">剑指 Offer 40. 最小的k个数</a><ol type="1"><li>说思路和时间复杂度</li></ol></li><li>一件自己比较自豪的事</li><li>反问</li></ol><h2 id="第-2-面">第 2 面</h2><ol type="1"><li>GET 和 POST 区别</li><li>DDoS 攻击，如何防御</li><li>客户端如何保存登录状态</li><li>跨域登录状态保持，从 taobao.com 切换到 tmall.com</li><li>缓存（cache）和缓冲（buffer）的区别</li><li>磁盘寻道算法<ol type="1"><li>针对存在高优先级任务如何改进</li></ol></li><li>软中断和硬中断</li><li>用户态和内核态，什么情况会切换到内核态</li><li>AVL 树和红黑树的对比</li><li>如何优化快排</li><li>为车牌号排序设计一个算法</li><li>在二叉搜索树中找比指定值大的最小节点</li><li>一片区域（矩阵）有若干水池（0）和陆地（1），求每个陆地节点到水池的最短距离</li><li>反问</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;美团面得快，凉得也快。&lt;/p&gt;
    
    </summary>
    
    
      <category term="面经" scheme="https://blog.dreace.top/categories/%E9%9D%A2%E7%BB%8F/"/>
    
    
      <category term="面经" scheme="https://blog.dreace.top/tags/%E9%9D%A2%E7%BB%8F/"/>
    
      <category term="美团" scheme="https://blog.dreace.top/tags/%E7%BE%8E%E5%9B%A2/"/>
    
  </entry>
  
  <entry>
    <title>奇安信服务端开发 Python 面经，共三面（2+1，已意向书）</title>
    <link href="https://blog.dreace.top/2020/Qianxin-Server-Development-Python-Interview-Experience-a-Total-of-Three-Times-2-1-Offer/"/>
    <id>https://blog.dreace.top/2020/Qianxin-Server-Development-Python-Interview-Experience-a-Total-of-Three-Times-2-1-Offer/</id>
    <published>2020-08-15T03:12:25.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css" integrity="sha384-dbVIfZGuN1Yq7/1Ocstc1lUEm+AT+/rCkibIcC/OmWo5f0EA48Vf8CytHzGrSwbQ" crossorigin="anonymous"><p>8月1日完成奇安信笔试，8月8日一口气完成三轮面试，到8月14日收到意向书邮件，秋招之路的第一份 Offer，感谢奇安信。</p><p>三轮面试包括 2 次技术面和 1 次 HR 面。</p><a id="more"></a><h2 id="第-1-面">第 1 面</h2><p>本来是 Python 面试，说着说着就到 Golang 了。</p><ol type="1"><li>自我介绍</li><li>Python 类可以定义哪几种方法<ol type="1"><li>静态方法和类方法应用场景</li></ol></li><li>Python 有哪些数据结构</li><li>Python 如何实现私有成员、方法</li><li>Python 协程</li><li>介绍项目<ol type="1"><li>做爬虫的时候用了哪些库</li><li>后端怎么部署的</li></ol></li><li>Docker 数据卷</li><li><code>Dockerfile</code> 中用过哪些指令</li><li>TCP/IP 模型有哪些层<ol type="1"><li>哪些层提供的是可靠的服务</li></ol></li><li>有哪些常用的数据结构</li><li>有哪些排序算法<ol type="1"><li>哪些是稳定的</li></ol></li><li>Golang 怎么实现面向对象</li><li>Golang 成员访问控制</li><li>Golang 有哪些数据结构</li><li>算法：1~n 自然数组排序，不能直接 <code>arr[i] = i + 1</code>，要求时间 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></li><li>算法：<a href="https://leetcode-cn.com/problems/lian-xu-zi-shu-zu-de-zui-da-he-lcof/" target="_blank" rel="noopener">剑指 Offer 42. 连续子数组的最大和</a></li></ol><h2 id="第-2-面">第 2 面</h2><ol type="1"><li>为什么还在家</li><li>工作地点有什么想法</li><li>为什么不考虑读研</li><li>最近在干什么</li><li>项目架构设计怎么来的</li><li>看 GitHub 上的项目问了一些相关问题<ol type="1"><li>怎么编排 Docker 容器的</li><li>有没有用过 ORM 框架</li><li>自己拼接 SQL 怎么做防注入</li><li>怎么做的 API 限流</li></ol></li><li>反问</li></ol><h2 id="第-3-面hr-面">第 3 面（HR 面）</h2><ol type="1"><li>自我介绍</li><li>在项目或比赛中承担什么角色</li><li>怎么理解的网络安全</li><li>职业规划</li><li>找工作有没有倾向</li><li>反问</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;8月1日完成奇安信笔试，8月8日一口气完成三轮面试，到8月14日收到意向书邮件，秋招之路的第一份 Offer，感谢奇安信。&lt;/p&gt;
&lt;p&gt;三轮面试包括 2 次技术面和 1 次 HR 面。&lt;/p&gt;
    
    </summary>
    
    
      <category term="面经" scheme="https://blog.dreace.top/categories/%E9%9D%A2%E7%BB%8F/"/>
    
    
      <category term="面经" scheme="https://blog.dreace.top/tags/%E9%9D%A2%E7%BB%8F/"/>
    
      <category term="奇安信" scheme="https://blog.dreace.top/tags/%E5%A5%87%E5%AE%89%E4%BF%A1/"/>
    
  </entry>
  
  <entry>
    <title>腾讯 CDG 后端面经，共六面（1+3+1+1）</title>
    <link href="https://blog.dreace.top/2020/Tencent-CDG-Back-End-Interview-Experience-a-Total-of-Six-Times-1-3-1-1/"/>
    <id>https://blog.dreace.top/2020/Tencent-CDG-Back-End-Interview-Experience-a-Total-of-Six-Times-1-3-1-1/</id>
    <published>2020-08-14T08:06:26.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p>8月4日晚上突然接到腾讯的电话，问有没有兴趣做支付方面的 C++ 开发，然后简单问了几个问题说第二天定个时间视频面。就这样到今天（8月14日）稀里糊涂地完成了 HR 面。</p><p>一共经历了 1 次电话面（简历面），3 次技术面，1 次「GM/EVP/面委会」面和 1 次 HR 面，希望可以拿到 Offer，提早结束提心吊胆的秋招。</p><a id="more"></a><h2 id="第-0-面电话面8月4日">第 0 面（电话面）/8月4日</h2><ol type="1"><li>自我介绍</li><li>项目<ol type="1"><li>数据库存密码方案</li></ol></li><li>TCP 三次握手</li><li>服务器超时没有收到第三次握手会发什么报文</li></ol><h2 id="第-1-面8月5日">第 1 面/8月5日</h2><p>没有录音，有些问题想不起来了。</p><ol type="1"><li>实现 <code>atoi</code> 函数</li><li>实现 C++ 单例模式</li><li>实现快排</li><li>C++ 静态成员</li><li>C++ 静态变量（成员）存放位置</li><li>TLS 握手过程<ol type="1"><li>证书包含哪些信息</li><li>客户端如何确认服务器身份</li><li>有哪些签名算法</li><li>双向认证</li></ol></li><li>Redis 的事务</li><li>中间人攻击</li><li>DDoS 攻击</li></ol><h2 id="第-2-面8月8日">第 2 面/8月8日</h2><p>对方介绍说是小组 leader，如果拿到 Offer 的话会在他手下干活，最后还说了一下具体的业务。录音出问题，只能回忆起部分问题。</p><ol type="1"><li>实现 TopN 查找</li><li>InnoDB 主键索引和辅助索引结构</li><li>C++ 中 <code>map</code> 与 <code>unordered_map</code> 区别，和适用场景</li><li>家在哪里，能不能接受去深圳</li></ol><p>实际上不止这些问题，如果能想起来再补上。</p><h2 id="第-3-面8月9日">第 3 面/8月9日</h2><ol type="1"><li>项目相关</li><li>是否对编程感兴趣</li><li>做项目的时候怎么选择技术栈</li><li>在团队中什么地位，周围人怎么评价自己</li><li>职业规划</li><li>十亿个 QQ 号判断一个是否在其中，性能达到 10 万 QPS</li><li>设计一个保障服务高可用的模型</li><li>有没有其他 Offer</li><li>有没有业务偏好</li></ol><h2 id="第-4-面总监面8月13日">第 4 面（总监面）/8月13日</h2><p>能感受到对面非常忙，八分钟就结束了。</p><ol type="1"><li>快速自我介绍</li><li>怎么定义「高可用」</li><li>反问</li><li>职业规划</li></ol><h2 id="第-5-面hr-面8月14日">第 5 面（HR 面）/8月14日</h2><ol type="1"><li>自我介绍</li><li>职业规划<ol type="1"><li>什么样的工作算满意</li></ol></li><li>开发方向偏好</li><li>短板，有没有去补足</li><li>有没有其他 Offer</li><li>和前面面试官聊得怎么样</li><li>没有实习吗</li><li>最有成就感的事</li><li>在深圳工作有问题吗，家里人支不支持</li></ol><p>最后问了一下 HR 什么时候出结果，回答说等其他人面试完，一到两周尽快给反馈。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;8月4日晚上突然接到腾讯的电话，问有没有兴趣做支付方面的 C++ 开发，然后简单问了几个问题说第二天定个时间视频面。就这样到今天（8月14日）稀里糊涂地完成了 HR 面。&lt;/p&gt;
&lt;p&gt;一共经历了 1 次电话面（简历面），3 次技术面，1 次「GM/EVP/面委会」面和 1 次 HR 面，希望可以拿到 Offer，提早结束提心吊胆的秋招。&lt;/p&gt;
    
    </summary>
    
    
      <category term="面经" scheme="https://blog.dreace.top/categories/%E9%9D%A2%E7%BB%8F/"/>
    
    
      <category term="面经" scheme="https://blog.dreace.top/tags/%E9%9D%A2%E7%BB%8F/"/>
    
      <category term="腾讯" scheme="https://blog.dreace.top/tags/%E8%85%BE%E8%AE%AF/"/>
    
  </entry>
  
  <entry>
    <title>解决 hexo-katex 错误地将中文编码为 HTML 字符实体</title>
    <link href="https://blog.dreace.top/2020/Solve-the-Problem-That-hexo-katex-Incorrectly-Encodes-Chinese-As-HTML-Character-Entities/"/>
    <id>https://blog.dreace.top/2020/Solve-the-Problem-That-hexo-katex-Incorrectly-Encodes-Chinese-As-HTML-Character-Entities/</id>
    <published>2020-08-01T12:32:12.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p>偶然发现博客正文中的中文都被编码成了 <a href="https://zh.wikipedia.org/wiki/%E5%AD%97%E7%AC%A6%E5%AE%9E%E4%BD%93%E5%BC%95%E7%94%A8" target="_blank" rel="noopener">HTML 字符实体</a>，也就是中文「静」被编码为 <code>&amp;#x9759;</code>，在 UTF-8 中一个中文字符由三个字符编码，而转成 HTML 字符实体后一个中文字符占 8 个字节，增加了 167%。一篇博客正文占据主要部分，四舍五入，转换后 HTML 文件体积比直接使用 UFT-8 编码大了一倍。</p><a id="more"></a><h2 id="定位问题">定位问题</h2><p>查阅资料得知可能是 cheerio 引起的问题<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>，在 node_modules 下查找发现 hexo-katex 引入了 cheerio 并设置了要编码实体，</p><p>定位到的代码（node_modules/hexo-katex/index.js:16）：</p><div class="sourceCode" id="cb1"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">var</span> $ <span class="op">=</span> <span class="va">cheerio</span>.<span class="at">load</span>(<span class="va">data</span>.<span class="at">content</span><span class="op">,</span> <span class="op">{</span> <span class="dt">decodeEntities</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</span></code></pre></div><h2 id="解决">解决</h2><p>既然问题找到了，解决办法也很简单，将 <code>true</code> 改为 <code>false</code>：</p><div class="sourceCode" id="cb2"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">var</span> $ <span class="op">=</span> <span class="va">cheerio</span>.<span class="at">load</span>(<span class="va">data</span>.<span class="at">content</span><span class="op">,</span> <span class="op">{</span> <span class="dt">decodeEntities</span><span class="op">:</span> <span class="kw">false</span> <span class="op">}</span>)</span></code></pre></div><p>但是，直接修改 node_modules 下的文件可能会丢失更改，或者需要在其他环境使用修改不能同步。由于我的博客是使用 CI/CD 自动编译并部署的，直接修改文件会比较麻烦。</p><p>这时就需要 <a href="https://github.com/ds300/patch-package" target="_blank" rel="noopener">patch-package</a> 了，patch-package 可以将更改固定，在每次安装依赖时自动应用更改。</p><h3 id="安装">安装</h3><p>首先要安装 patch-package：</p><pre class="shell"><code>yarn add patch-package postinstall-postinstall</code></pre><p>如果使用 npm 则是：</p><pre class="shell"><code>npm i patch-package</code></pre><p>然后在 package.json 的 <code>scripts</code> 字段下新增：</p><div class="sourceCode" id="cb5"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1"></a><span class="er">&quot;postinstall&quot;:</span> <span class="er">&quot;patch-package&quot;,</span></span></code></pre></div><p>表明在依赖安装后会执行 <code>patch-package</code>。</p><h3 id="固定修改">固定修改</h3><p>首先保存已修改的文件，然后执行：</p><pre class="shell"><code>yarn patch-package &lt;修改了的包名&gt;</code></pre><p>或者使用 npx：</p><pre class="shell"><code>npx patch-package &lt;修改了的包名&gt;</code></pre><p>此时将看到类似：</p><pre class="text"><code>yarn run v1.22.4$ patch-packagepatch-package 6.2.2Applying patches...hexo-katex@0.0.13 ✔Done in 1.13s.</code></pre><p>的输出，表明修改已经固定。</p><p>在 patches 目录下会有对应的 <code>.patch</code> 文件，本文对应的文件如下：</p><div class="sourceCode" id="cb9"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">diff --git a/node_modules/hexo-katex/index.js b/node_modules/hexo-katex/index.js</span></span><span id="cb9-2"><a href="#cb9-2"></a>index cf8daf8..98fb8c6 100644</span><span id="cb9-3"><a href="#cb9-3"></a><span class="dt">--- a/node_modules/hexo-katex/index.js</span></span><span id="cb9-4"><a href="#cb9-4"></a><span class="dt">+++ b/node_modules/hexo-katex/index.js</span></span><span id="cb9-5"><a href="#cb9-5"></a><span class="dt">@@ -13,7 +13,7 @@ hexo.extend.filter.register(&#39;after_post_render&#39;, function(data) {</span></span><span id="cb9-6"><a href="#cb9-6"></a> </span><span id="cb9-7"><a href="#cb9-7"></a>   if (!cheerio) cheerio = require(&#39;cheerio&#39;)</span><span id="cb9-8"><a href="#cb9-8"></a> </span><span id="cb9-9"><a href="#cb9-9"></a><span class="st">-  var $ = cheerio.load(data.content, { decodeEntities: true })</span></span><span id="cb9-10"><a href="#cb9-10"></a><span class="va">+  var $ = cheerio.load(data.content, { decodeEntities: false })</span></span><span id="cb9-11"><a href="#cb9-11"></a> </span><span id="cb9-12"><a href="#cb9-12"></a>   if ($(&#39;.math&#39;).length &gt; 0) {</span><span id="cb9-13"><a href="#cb9-13"></a>     linkTag = util.htmlTag(&#39;link&#39;, {</span></code></pre></div><h3 id="应用更改">应用更改</h3><p>只要将上述生成的文件提交到版本控制系统，在其他环境安装依赖时直接使用 <code>yarn install</code> 或 <code>npm install</code> 即可同步修改。</p><section class="footnotes" role="doc-endnotes"><hr><ol><li id="fn1" role="doc-endnote"><p><a href="https://github.com/hexojs/hexo/issues/657" target="_blank" rel="noopener">https://github.com/hexojs/hexo/issues/657</a> "網頁能正常顯示中文，但查看HTML源代碼卻出現亂碼"<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li></ol></section>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;偶然发现博客正文中的中文都被编码成了 &lt;a href=&quot;https://zh.wikipedia.org/wiki/%E5%AD%97%E7%AC%A6%E5%AE%9E%E4%BD%93%E5%BC%95%E7%94%A8&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;HTML 字符实体&lt;/a&gt;，也就是中文「静」被编码为 &lt;code&gt;&amp;amp;#x9759;&lt;/code&gt;，在 UTF-8 中一个中文字符由三个字符编码，而转成 HTML 字符实体后一个中文字符占 8 个字节，增加了 167%。一篇博客正文占据主要部分，四舍五入，转换后 HTML 文件体积比直接使用 UFT-8 编码大了一倍。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Hexo" scheme="https://blog.dreace.top/categories/Hexo/"/>
    
    
      <category term="Hexo" scheme="https://blog.dreace.top/tags/Hexo/"/>
    
      <category term="JavaScript" scheme="https://blog.dreace.top/tags/JavaScript/"/>
    
      <category term="npm" scheme="https://blog.dreace.top/tags/npm/"/>
    
  </entry>
  
  <entry>
    <title>Python 手动实现数字验证码识别</title>
    <link href="https://blog.dreace.top/2020/Use-Python-to-Manually-Realize-Mumeral-Verification-Code-Recognition/"/>
    <id>https://blog.dreace.top/2020/Use-Python-to-Manually-Realize-Mumeral-Verification-Code-Recognition/</id>
    <published>2020-07-27T14:11:37.000Z</published>
    <updated>2023-01-10T14:30:55.299Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css" integrity="sha384-dbVIfZGuN1Yq7/1Ocstc1lUEm+AT+/rCkibIcC/OmWo5f0EA48Vf8CytHzGrSwbQ" crossorigin="anonymous"><p>（迁移文章，本文写于2019年8月3日）本人维护的一个项目 <a href="https://github.com/Dreace/NUC-Information" target="_blank" rel="noopener">中北信息</a> 小程序需要模拟登录来获取信息，这就需要在后台识别验证码。需要识别的验证码比较简单且为纯数字，有简单到可以忽略不计的变形，像下面这个样子。</p><a id="more"></a><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/Use-Python-to-Manually-Realize-Mumeral-Verification-Code-Recognition/example.png" alt><figcaption>验证码样例</figcaption></figure><p>可以看到稍微有一点噪点，应该是压缩解压过程造成的（<a href="https://zh.wikipedia.org/zh-cn/JPEG" target="_blank" rel="noopener">JPG</a> 是有损压缩）。</p><p>这是近乎标准印刷体的四位数字，只是有稍微倾斜，最开始想到的办法是 OCR 。</p><p>最初使用 <a href="https://github.com/tesseract-ocr/tesseract" target="_blank" rel="noopener">Tesseract</a> 进行本地 OCR 。效果不是很理想，重要问题是 Tesseract 是通用 OCR，他会识别所有的英文字符和标点，这就造成大量的识别不准确。而且 Tesseract 是一个神经网络，在本地运行相当耗费资源。在平时可以应付大部分情况，但在访问高峰时会消耗大量时间在多个识别线程中切换，甚至直接造成服务器宕机。 在没有新的解决方案之前使用了接近一年，只能说勉强能用。</p><p>前不久，发现百度云的 OCR 提供每天 5 万次的免费调用，测试发现可以使用且效果不错。使用一段时间后发现一些问题，异步的调用方式造成的延迟不可忽略，尤其是网络延迟。测试发现这个解决方案每个验证码识别有将近 1s 的网络延迟，这使得后台响应时间被延长，影响用户体验。虽然百度云不会将数字识别成其他字符，但经常出现只识别出两位数字的情况造成大量重试，更加影响性能。</p><p>两度更换解决方案后，还是没能找到令人满意的方案。决定自己实现验证码的识别，这里不需要训练神经网络，直接通过规则匹配能得到很好的性能与效果，最终单个验证码识别时间为 4-5ms，正确率 100%。</p><p>识别步骤如下：</p><ol type="1"><li>灰度化</li><li>二值化</li><li>切割为单个数字</li><li>和字库对比</li></ol><h2 id="导入需要用到库">导入需要用到库</h2><div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">import</span> math</span><span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> time</span><span id="cb1-3"><a href="#cb1-3"></a><span class="im">from</span> io <span class="im">import</span> BytesIO</span><span id="cb1-4"><a href="#cb1-4"></a></span><span id="cb1-5"><a href="#cb1-5"></a><span class="im">import</span> numpy <span class="im">as</span> np</span><span id="cb1-6"><a href="#cb1-6"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span><span id="cb1-7"><a href="#cb1-7"></a></span><span id="cb1-8"><a href="#cb1-8"></a><span class="im">import</span> data</span></code></pre></div><p>最后一行导入的是字库，后面会写到。</p><h2 id="灰度化">灰度化</h2><p>从之前的例子可以看到图像有一些噪点，为了不让其干扰识别需要进行降噪处理，第一步是将图片灰度化。所谓灰度化是将 RGB 色彩空间中三个量合并成一个量 L，这样原本的彩色图像变成灰度图了。每个像素的取值也由 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>25</mn><msup><mn>6</mn><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">256^{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mord"><span class="mord">6</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span>（16777216）个减少到 256 个，能够减少后继的计算量。将上面的图片灰度化之后变成下面的样子。</p><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/Use-Python-to-Manually-Realize-Mumeral-Verification-Code-Recognition/图2.png" alt><figcaption>灰度化后</figcaption></figure><p>处理代码：</p><div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># 灰度处理并创建二维矩阵</span></span><span id="cb2-2"><a href="#cb2-2"></a>img_matrix <span class="op">=</span> np.array(Image.<span class="bu">open</span>(BytesIO(image_bytes)).convert(<span class="st">&quot;L&quot;</span>))</span></code></pre></div><p>其中 <code>Image.open(BytesIO(image_bytes)).convert("L")</code> 是从 <code>image_bytes</code> 中创建图像并转为灰度图， <code>image_bytes</code>  可以是从网络加载或从本地文件读入的字节数据。然后根据灰度图创建一个 <a href="https://numpy.org/" target="_blank" rel="noopener">NumPy</a> 矩阵方便后面的运算。</p><p>灰度化之后与原图好像没有区别是因为原图本身是黑白的，如果原图是彩色的话能够很明显地看出区别。</p><h2 id="二值化">二值化</h2><p>二值化是将图像的像素与某个阈值比较，若大于这个阈值则设置为灰度最大值（这里是 1，白色），小于某个值则设为灰度最小值（这里是 0，黑色）。这样上一步的灰度图就转化为二值图，便于接下来的图像分割。选择合适的阈值还可以去除图像噪点。</p><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/Use-Python-to-Manually-Realize-Mumeral-Verification-Code-Recognition/图3-1595862311679.png" alt><figcaption>二值化后</figcaption></figure><p>二值化后噪点已经完全消失，数字的边界更加锐利。</p><p>处理代码：</p><div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># 获取矩阵（图像）的长宽</span></span><span id="cb3-2"><a href="#cb3-2"></a>rows, cols <span class="op">=</span> img_matrix.shape</span><span id="cb3-3"><a href="#cb3-3"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(rows):</span><span id="cb3-4"><a href="#cb3-4"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(cols):</span><span id="cb3-5"><a href="#cb3-5"></a>        <span class="co"># 与阈值比较</span></span><span id="cb3-6"><a href="#cb3-6"></a>        <span class="cf">if</span> img_matrix[i, j] <span class="op">&lt;=</span> <span class="dv">128</span>:</span><span id="cb3-7"><a href="#cb3-7"></a>            <span class="co"># 设为灰度最小值</span></span><span id="cb3-8"><a href="#cb3-8"></a>            img_matrix[i, j] <span class="op">=</span> <span class="dv">0</span></span><span id="cb3-9"><a href="#cb3-9"></a>        <span class="cf">else</span>:</span><span id="cb3-10"><a href="#cb3-10"></a>            <span class="co"># 设为灰度最大值</span></span><span id="cb3-11"><a href="#cb3-11"></a>            img_matrix[i, j] <span class="op">=</span> <span class="dv">1</span></span></code></pre></div><h2 id="切割为单个数字">切割为单个数字</h2><p>二值化后可以看到图像中有大量的空白，这对于识别会造成一些影响，并且对比多个验证码发现数字的垂直位置并非固定，也就是上下边距是浮动的。因此要将空白部分删掉只保留有图像的部分 。 先看实现：</p><div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># 每行最小值</span></span><span id="cb4-2"><a href="#cb4-2"></a>row_min <span class="op">=</span> np.<span class="bu">min</span>(img_matrix, axis<span class="op">=</span><span class="dv">1</span>)</span><span id="cb4-3"><a href="#cb4-3"></a><span class="co"># 找到第一个有图像的行</span></span><span id="cb4-4"><a href="#cb4-4"></a>row_start <span class="op">=</span> np.argmin(row_min)</span><span id="cb4-5"><a href="#cb4-5"></a><span class="co"># 找到最后一个有图像的行</span></span><span id="cb4-6"><a href="#cb4-6"></a>row_end <span class="op">=</span> np.argmin(np.flip(row_min))</span><span id="cb4-7"><a href="#cb4-7"></a><span class="co"># 只取有图像的行</span></span><span id="cb4-8"><a href="#cb4-8"></a>img_matrix <span class="op">=</span> img_matrix[row_start:<span class="op">-</span>row_end, :]</span></code></pre></div><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/Use-Python-to-Manually-Realize-Mumeral-Verification-Code-Recognition/图4.png" alt><figcaption>去除上下空白</figcaption></figure><p><code>row_min</code> 的值为</p><div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a>[<span class="dv">1</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">1</span>]</span></code></pre></div><p>其中 1 表示该行最小值为 1 ，在本例中表示这一行都是 1 ，即没有黑色像素。0 则表示这一行有 0 的存在，即存在黑色像素，也就是这一行有图像，需要保留。<code>np.argmin()</code> 在 <code>row_min</code> 中查找最小值第一次出现的位置，即为图像开始行。将 <code>row_min</code> 反转之后再次查找最小值下标就得到了结束下标，这个下标的是从右向左计数的。 得到 <code>row_start</code> 和 <code>row_end</code> 后对矩阵进行切片，<code>row_end</code> 要取负值表示表示从右开始计数。</p><p>接下来将数字切片成单个：</p><div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a>codes <span class="op">=</span> [<span class="dv">0</span>] <span class="op">*</span> <span class="dv">4</span></span><span id="cb6-2"><a href="#cb6-2"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span><span id="cb6-3"><a href="#cb6-3"></a>    <span class="co"># 切片</span></span><span id="cb6-4"><a href="#cb6-4"></a>    imag_matrix_spited <span class="op">=</span> img_matrix[:, <span class="dv">19</span> <span class="op">*</span> i:<span class="dv">19</span> <span class="op">*</span> (i <span class="op">+</span> <span class="dv">1</span>)]</span><span id="cb6-5"><a href="#cb6-5"></a>    col_min <span class="op">=</span> np.<span class="bu">min</span>(imag_matrix_spited, axis<span class="op">=</span><span class="dv">0</span>)</span><span id="cb6-6"><a href="#cb6-6"></a>    col_start <span class="op">=</span> np.argmin(col_min)</span><span id="cb6-7"><a href="#cb6-7"></a>    col_end <span class="op">=</span> np.argmin(np.flip(col_min))</span><span id="cb6-8"><a href="#cb6-8"></a>    <span class="co"># 图像宽度</span></span><span id="cb6-9"><a href="#cb6-9"></a>    width <span class="op">=</span> col_min.shape[<span class="dv">0</span>] <span class="op">-</span> (col_start <span class="op">+</span> col_end)</span><span id="cb6-10"><a href="#cb6-10"></a>    <span class="co"># 宽度扩宽到 9 像素</span></span><span id="cb6-11"><a href="#cb6-11"></a>    width_rest <span class="op">=</span> <span class="dv">9</span> <span class="op">-</span> width</span><span id="cb6-12"><a href="#cb6-12"></a>    <span class="co"># 左边界</span></span><span id="cb6-13"><a href="#cb6-13"></a>    col_start <span class="op">-=</span> <span class="bu">int</span>(math.ceil(width_rest <span class="op">/</span> <span class="fl">2.0</span>))</span><span id="cb6-14"><a href="#cb6-14"></a>    <span class="co"># 右边界</span></span><span id="cb6-15"><a href="#cb6-15"></a>    col_end <span class="op">-=</span> <span class="bu">int</span>(math.floor(width_rest <span class="op">/</span> <span class="fl">2.0</span>))</span><span id="cb6-16"><a href="#cb6-16"></a>    <span class="co"># 裁剪为 9 像素宽的图像</span></span><span id="cb6-17"><a href="#cb6-17"></a>    imag_matrix_spited <span class="op">=</span> imag_matrix_spited[:, col_start:<span class="op">-</span>col_end]</span></code></pre></div><p>先粗略裁剪为每个数字 20 像素，然后再判断左边界和右边界，同之前一样的算法。但是这里不能直接使用得到的边界，每个数字的宽度不一样，直接切片会导致矩阵大小不一样，会影响之后的计算。因此要将将宽度统一为 9 像素，即为最宽的数字宽度。</p><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/Use-Python-to-Manually-Realize-Mumeral-Verification-Code-Recognition/图5-1.png" alt><figcaption>切片结果-8</figcaption></figure><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/Use-Python-to-Manually-Realize-Mumeral-Verification-Code-Recognition/图5-2.png" alt><figcaption>切片结果-4</figcaption></figure><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/Use-Python-to-Manually-Realize-Mumeral-Verification-Code-Recognition/图5-3.png" alt><figcaption>切片结果-0</figcaption></figure><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/Use-Python-to-Manually-Realize-Mumeral-Verification-Code-Recognition/图5-4.png" alt><figcaption>切片结果-3</figcaption></figure><h2 id="和字库对比">和字库对比</h2><div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>res <span class="op">=</span> [<span class="dv">0</span>] <span class="op">*</span> <span class="dv">10</span></span><span id="cb7-2"><a href="#cb7-2"></a><span class="co"># 展开成一维</span></span><span id="cb7-3"><a href="#cb7-3"></a>x <span class="op">=</span> imag_matrix_spited.flatten()</span><span id="cb7-4"><a href="#cb7-4"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span><span id="cb7-5"><a href="#cb7-5"></a>    <span class="co"># 一次取字库中标准数据</span></span><span id="cb7-6"><a href="#cb7-6"></a>    y <span class="op">=</span> data.array_map[j]</span><span id="cb7-7"><a href="#cb7-7"></a>    <span class="co"># 通过异或计算不同元素的数量</span></span><span id="cb7-8"><a href="#cb7-8"></a>    res[j] <span class="op">=</span> np.<span class="bu">sum</span>(x <span class="op">^</span> y)</span><span id="cb7-9"><a href="#cb7-9"></a>    <span class="co"># 取差异最小的下标</span></span><span id="cb7-10"><a href="#cb7-10"></a>codes[i] <span class="op">=</span> <span class="bu">str</span>(np.argmin(res))</span></code></pre></div><p>首先将原先的二维矩阵展开为一维，再与字库中的数据对比找到差异最小的那个既是最终结果，这样整个验证码就识别出来了。字库则需要将展开后的矩阵按照顺序整理一下得到。</p><p>下面是针对这种验证码的字库（0~9）：</p><div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span><span id="cb8-2"><a href="#cb8-2"></a></span><span id="cb8-3"><a href="#cb8-3"></a>array_map <span class="op">=</span> [<span class="dv">0</span>] <span class="op">*</span> <span class="dv">10</span></span><span id="cb8-4"><a href="#cb8-4"></a>array_map[<span class="dv">0</span>] <span class="op">=</span> np.array(</span><span id="cb8-5"><a href="#cb8-5"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-6"><a href="#cb8-6"></a>     <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-7"><a href="#cb8-7"></a>     <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span><span id="cb8-8"><a href="#cb8-8"></a>array_map[<span class="dv">1</span>] <span class="op">=</span> np.array(</span><span id="cb8-9"><a href="#cb8-9"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-10"><a href="#cb8-10"></a>     <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-11"><a href="#cb8-11"></a>     <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>])</span><span id="cb8-12"><a href="#cb8-12"></a>array_map[<span class="dv">2</span>] <span class="op">=</span> np.array(</span><span id="cb8-13"><a href="#cb8-13"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-14"><a href="#cb8-14"></a>     <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>,</span><span id="cb8-15"><a href="#cb8-15"></a>     <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span><span id="cb8-16"><a href="#cb8-16"></a>array_map[<span class="dv">3</span>] <span class="op">=</span> np.array(</span><span id="cb8-17"><a href="#cb8-17"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-18"><a href="#cb8-18"></a>     <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-19"><a href="#cb8-19"></a>     <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span><span id="cb8-20"><a href="#cb8-20"></a>array_map[<span class="dv">4</span>] <span class="op">=</span> np.array(</span><span id="cb8-21"><a href="#cb8-21"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-22"><a href="#cb8-22"></a>     <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>,</span><span id="cb8-23"><a href="#cb8-23"></a>     <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span><span id="cb8-24"><a href="#cb8-24"></a>array_map[<span class="dv">5</span>] <span class="op">=</span> np.array(</span><span id="cb8-25"><a href="#cb8-25"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-26"><a href="#cb8-26"></a>     <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-27"><a href="#cb8-27"></a>     <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span><span id="cb8-28"><a href="#cb8-28"></a>array_map[<span class="dv">6</span>] <span class="op">=</span> np.array(</span><span id="cb8-29"><a href="#cb8-29"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-30"><a href="#cb8-30"></a>     <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-31"><a href="#cb8-31"></a>     <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span><span id="cb8-32"><a href="#cb8-32"></a>array_map[<span class="dv">7</span>] <span class="op">=</span> np.array(</span><span id="cb8-33"><a href="#cb8-33"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-34"><a href="#cb8-34"></a>     <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>,</span><span id="cb8-35"><a href="#cb8-35"></a>     <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span><span id="cb8-36"><a href="#cb8-36"></a>array_map[<span class="dv">8</span>] <span class="op">=</span> np.array(</span><span id="cb8-37"><a href="#cb8-37"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-38"><a href="#cb8-38"></a>     <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>,</span><span id="cb8-39"><a href="#cb8-39"></a>     <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span><span id="cb8-40"><a href="#cb8-40"></a>array_map[<span class="dv">9</span>] <span class="op">=</span> np.array(</span><span id="cb8-41"><a href="#cb8-41"></a>    [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-42"><a href="#cb8-42"></a>     <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span><span id="cb8-43"><a href="#cb8-43"></a>     <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span></code></pre></div><p>至此验证码识别成功。</p><h2 id="最后">最后</h2><p>完整的代码和一百个测试验证码可以在 <a href="https://github.com/Dreace/IVC" target="_blank" rel="noopener">Dreace/IVC</a> 找到。</p><p>要求环境为 Python 3+，运行前请先安装 <code>requirements.txt</code> 中的依赖。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;（迁移文章，本文写于2019年8月3日）本人维护的一个项目 &lt;a href=&quot;https://github.com/Dreace/NUC-Information&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;中北信息&lt;/a&gt; 小程序需要模拟登录来获取信息，这就需要在后台识别验证码。需要识别的验证码比较简单且为纯数字，有简单到可以忽略不计的变形，像下面这个样子。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python" scheme="https://blog.dreace.top/categories/Python/"/>
    
    
      <category term="网络" scheme="https://blog.dreace.top/tags/%E7%BD%91%E7%BB%9C/"/>
    
      <category term="Python" scheme="https://blog.dreace.top/tags/Python/"/>
    
      <category term="验证码识别" scheme="https://blog.dreace.top/tags/%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/"/>
    
  </entry>
  
  <entry>
    <title>使用 TypeScript 编写命令行工具并发布到 npm</title>
    <link href="https://blog.dreace.top/2020/Use-TypeScript-to-Write-Command-Line-Tools-and-Publish-to-npm/"/>
    <id>https://blog.dreace.top/2020/Use-TypeScript-to-Write-Command-Line-Tools-and-Publish-to-npm/</id>
    <published>2020-07-25T02:01:41.000Z</published>
    <updated>2023-01-10T14:30:55.299Z</updated>
    
    <content type="html"><![CDATA[<p>最近在研究优化在国内访问静态博客的时间，其中有一个方案是将生成的文件存储在对象存储，然后再通过 CDN 回源对象存储。确定方案后使用 <a href="https://www.qiniu.com/" target="_blank" rel="noopener">七牛云</a> 做一个加速实验，由于要将生成的文件上传，又要将这个过程尽可能自动化，而七牛云只提供 SDK，要上传只能将密钥硬编码在代码中，这是很危险的。</p><p>因此有了编写一个命令行工具的想法，由于最近在学习 TypeScript，就决定用它来写。</p><a id="more"></a><h2 id="准备环境">准备环境</h2><p>在开始编写逻辑代码前需要准备一下开发环境。</p><p>首先初始化项目<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>：</p><pre class="shell"><code>yarn init -y</code></pre><p>本文将使用 yarn 作为包管理工具。</p><p>安装 TypeScript 支持：</p><pre class="shell"><code>yarn add global typescript ts-node-dev</code></pre><p><code>ts-node-dev</code> 可以直接启动 <code>.ts</code> 文件，如果使用 <code>tsc &amp;&amp; node "path/to/file.js"</code> 自行编译并启动则不需要这个依赖。</p><p>这两个依赖需要全局安装，因为他们分别提供 <code>tsc</code> 和 <code>ts-node-dev</code> 命令。</p><p>安装 Node.js 类型声明文件：</p><pre class="shell"><code>yarn add --dev @types/node</code></pre><p>以上是必备的开发依赖，除此还可以使用 ESLint 和 Prettier 来检查语法和规范格式。</p><p>以下配置内容均为可选，可以单独使用或组合使用。</p><h3 id="使用-eslint2">使用 ESLint<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></h3><p>ESLint 可以静态分析代码，能够尽早发现编码中的错误。</p><p>首先安装需要的依赖：</p><pre class="shell"><code>yarn add --dev @typescript-eslint/parser @typescript-eslint/eslint-plugin</code></pre><p>在根目录下创建 <code>.eslintrc.js</code> 文件并写入：</p><div class="sourceCode" id="cb5"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1"></a><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></span><span id="cb5-2"><a href="#cb5-2"></a>    <span class="dt">parser</span><span class="op">:</span> <span class="st">&#39;@typescript-eslint/parser&#39;</span><span class="op">,</span></span><span id="cb5-3"><a href="#cb5-3"></a>    <span class="dt">extends</span><span class="op">:</span> [<span class="st">&#39;plugin:@typescript-eslint/recommended&#39;</span>]<span class="op">,</span></span><span id="cb5-4"><a href="#cb5-4"></a>    <span class="dt">plugins</span><span class="op">:</span> [<span class="st">&#39;@typescript-eslint&#39;</span>]<span class="op">,</span></span><span id="cb5-5"><a href="#cb5-5"></a>    <span class="dt">env</span><span class="op">:</span> <span class="op">{</span></span><span id="cb5-6"><a href="#cb5-6"></a>        <span class="dt">node</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span><span id="cb5-7"><a href="#cb5-7"></a>    <span class="op">}</span></span><span id="cb5-8"><a href="#cb5-8"></a><span class="op">}</span></span></code></pre></div><p>更多的配置可以查看 <a href="https://eslint.org/docs/user-guide/configuring" target="_blank" rel="noopener">Configuring ESLint</a>。</p><h3 id="使用-prettier">使用 Prettier</h3><p>Prettier 可以通过配置文件来格式化代码，非常适合团队内规范代码。</p><p>首先安装 Prettier：</p><pre class="shell"><code>yarn add --dev prettier</code></pre><p>在根目录下创建 <code>prettier.config.js</code> 文件，并写入<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>：</p><div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1"></a><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></span><span id="cb7-2"><a href="#cb7-2"></a>  <span class="co">// 一行最多 100 字符</span></span><span id="cb7-3"><a href="#cb7-3"></a>  <span class="dt">printWidth</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span></span><span id="cb7-4"><a href="#cb7-4"></a>  <span class="co">// 使用 4 个空格缩进</span></span><span id="cb7-5"><a href="#cb7-5"></a>  <span class="dt">tabWidth</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span><span id="cb7-6"><a href="#cb7-6"></a>  <span class="co">// 不使用缩进符，而使用空格</span></span><span id="cb7-7"><a href="#cb7-7"></a>  <span class="dt">useTabs</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span><span id="cb7-8"><a href="#cb7-8"></a>  <span class="co">// 行尾需要有分号</span></span><span id="cb7-9"><a href="#cb7-9"></a>  <span class="dt">semi</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span><span id="cb7-10"><a href="#cb7-10"></a>  <span class="co">// 使用单引号</span></span><span id="cb7-11"><a href="#cb7-11"></a>  <span class="dt">singleQuote</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span><span id="cb7-12"><a href="#cb7-12"></a>  <span class="co">// 对象的 key 仅在必要时用引号</span></span><span id="cb7-13"><a href="#cb7-13"></a>  <span class="dt">quoteProps</span><span class="op">:</span> <span class="st">&#39;as-needed&#39;</span><span class="op">,</span></span><span id="cb7-14"><a href="#cb7-14"></a>  <span class="co">// jsx 不使用单引号，而使用双引号</span></span><span id="cb7-15"><a href="#cb7-15"></a>  <span class="dt">jsxSingleQuote</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span><span id="cb7-16"><a href="#cb7-16"></a>  <span class="co">// 末尾不需要逗号</span></span><span id="cb7-17"><a href="#cb7-17"></a>  <span class="dt">trailingComma</span><span class="op">:</span> <span class="st">&#39;all&#39;</span><span class="op">,</span></span><span id="cb7-18"><a href="#cb7-18"></a>  <span class="co">// 大括号内的首尾需要空格</span></span><span id="cb7-19"><a href="#cb7-19"></a>  <span class="dt">bracketSpacing</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span><span id="cb7-20"><a href="#cb7-20"></a>  <span class="co">// jsx 标签的反尖括号需要换行</span></span><span id="cb7-21"><a href="#cb7-21"></a>  <span class="dt">jsxBracketSameLine</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span><span id="cb7-22"><a href="#cb7-22"></a>  <span class="co">// 箭头函数，只有一个参数的时候，也需要括号</span></span><span id="cb7-23"><a href="#cb7-23"></a>  <span class="dt">arrowParens</span><span class="op">:</span> <span class="st">&#39;always&#39;</span><span class="op">,</span></span><span id="cb7-24"><a href="#cb7-24"></a>  <span class="co">// 每个文件格式化的范围是文件的全部内容</span></span><span id="cb7-25"><a href="#cb7-25"></a>  <span class="dt">rangeStart</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span><span id="cb7-26"><a href="#cb7-26"></a>  <span class="dt">rangeEnd</span><span class="op">:</span> <span class="kw">Infinity</span><span class="op">,</span></span><span id="cb7-27"><a href="#cb7-27"></a>  <span class="co">// 不需要写文件开头的 @prettier</span></span><span id="cb7-28"><a href="#cb7-28"></a>  <span class="dt">requirePragma</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span><span id="cb7-29"><a href="#cb7-29"></a>  <span class="co">// 不需要自动在文件开头插入 @prettier</span></span><span id="cb7-30"><a href="#cb7-30"></a>  <span class="dt">insertPragma</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span><span id="cb7-31"><a href="#cb7-31"></a>  <span class="co">// 使用默认的折行标准</span></span><span id="cb7-32"><a href="#cb7-32"></a>  <span class="dt">proseWrap</span><span class="op">:</span> <span class="st">&#39;preserve&#39;</span><span class="op">,</span></span><span id="cb7-33"><a href="#cb7-33"></a>  <span class="co">// 根据显示样式决定 html 要不要折行</span></span><span id="cb7-34"><a href="#cb7-34"></a>  <span class="dt">htmlWhitespaceSensitivity</span><span class="op">:</span> <span class="st">&#39;css&#39;</span><span class="op">,</span></span><span id="cb7-35"><a href="#cb7-35"></a>  <span class="co">// 换行符使用 lf</span></span><span id="cb7-36"><a href="#cb7-36"></a>  <span class="dt">endOfLine</span><span class="op">:</span> <span class="st">&#39;lf&#39;</span><span class="op">,</span></span><span id="cb7-37"><a href="#cb7-37"></a><span class="op">};</span></span></code></pre></div><p>更多配置可查看 <a href="https://prettier.io/docs/en/index.html" target="_blank" rel="noopener">What is Prettier?</a>。</p><h3 id="在-webstorm-中启用-eslint-和-prettier">在 WebStorm 中启用 ESLint 和 Prettier</h3><h4 id="启用-eslint">启用 ESLint</h4><p>找到 File | Settings | Languages &amp; Frameworks | JavaScript | Code Quality Tools | ESLint 配置项，选择 Automatic ESLint configuration。</p><p>WebStorm 会自动查找 ESLint 路径并执行检查。</p><h4 id="启用-prettier">启用 Prettier</h4><p>找到 File | Settings | Languages &amp; Frameworks | JavaScript | Prettier 配置项，选择 Prettier 路径，可以勾选 Run on save for files，在保存时自动执行检查。</p><h4 id="使用-editorconfig">使用 EditorConfig</h4><p>EditorConfig 可以通过配置文件来指定不同 IDE 或编辑器的代码格式化行为，在编码期间就能根据团队规范格式化代码。</p><p>WebStorm 已经内置实现 EditorConfig 支持，在根目录创建 <code>.editorconfig</code> 文件，并写入：</p><div class="sourceCode" id="cb8"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># http://editorconfig.org</span></span><span id="cb8-2"><a href="#cb8-2"></a><span class="dt">root </span><span class="ot">=</span><span class="st"> </span><span class="kw">true</span></span><span id="cb8-3"><a href="#cb8-3"></a></span><span id="cb8-4"><a href="#cb8-4"></a><span class="kw">[*]</span></span><span id="cb8-5"><a href="#cb8-5"></a><span class="dt">indent_style </span><span class="ot">=</span><span class="st"> space</span></span><span id="cb8-6"><a href="#cb8-6"></a><span class="dt">indent_size </span><span class="ot">=</span><span class="st"> </span><span class="dv">2</span></span><span id="cb8-7"><a href="#cb8-7"></a><span class="dt">end_of_line </span><span class="ot">=</span><span class="st"> lf</span></span><span id="cb8-8"><a href="#cb8-8"></a><span class="dt">charset </span><span class="ot">=</span><span class="st"> utf</span><span class="dv">-8</span></span><span id="cb8-9"><a href="#cb8-9"></a><span class="dt">trim_trailing_whitespace </span><span class="ot">=</span><span class="st"> </span><span class="kw">true</span></span><span id="cb8-10"><a href="#cb8-10"></a><span class="dt">insert_final_newline </span><span class="ot">=</span><span class="st"> </span><span class="kw">true</span></span><span id="cb8-11"><a href="#cb8-11"></a></span><span id="cb8-12"><a href="#cb8-12"></a><span class="kw">[*.md]</span></span><span id="cb8-13"><a href="#cb8-13"></a><span class="dt">trim_trailing_whitespace </span><span class="ot">=</span><span class="st"> </span><span class="kw">false</span></span><span id="cb8-14"><a href="#cb8-14"></a></span><span id="cb8-15"><a href="#cb8-15"></a><span class="kw">[*.ts]</span></span><span id="cb8-16"><a href="#cb8-16"></a><span class="dt">ij_typescript_spaces_within_imports </span><span class="ot">=</span><span class="st"> </span><span class="kw">true</span></span><span id="cb8-17"><a href="#cb8-17"></a></span><span id="cb8-18"><a href="#cb8-18"></a><span class="kw">[Makefile]</span></span><span id="cb8-19"><a href="#cb8-19"></a><span class="dt">indent_style </span><span class="ot">=</span><span class="st"> tab</span></span></code></pre></div><p>以上配置效果和 Prettier 相同，更多配置可查看 <a href="https://editorconfig.org/#overview" target="_blank" rel="noopener">EditorConfig</a>。</p><h3 id="配置-typescript">配置 TypeScript</h3><p>在根目录下创建 <code>tsconfig.json</code> 文件，并写入：</p><div class="sourceCode" id="cb9"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">{</span></span><span id="cb9-2"><a href="#cb9-2"></a>  <span class="dt">&quot;compilerOptions&quot;</span><span class="fu">:</span> <span class="fu">{</span></span><span id="cb9-3"><a href="#cb9-3"></a>    <span class="dt">&quot;target&quot;</span><span class="fu">:</span> <span class="st">&quot;es5&quot;</span><span class="fu">,</span></span><span id="cb9-4"><a href="#cb9-4"></a>    <span class="dt">&quot;module&quot;</span><span class="fu">:</span> <span class="st">&quot;commonjs&quot;</span><span class="fu">,</span></span><span id="cb9-5"><a href="#cb9-5"></a>    <span class="dt">&quot;outDir&quot;</span><span class="fu">:</span> <span class="st">&quot;./dist&quot;</span><span class="fu">,</span></span><span id="cb9-6"><a href="#cb9-6"></a>    <span class="dt">&quot;strict&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span><span id="cb9-7"><a href="#cb9-7"></a>    <span class="dt">&quot;esModuleInterop&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span><span id="cb9-8"><a href="#cb9-8"></a>    <span class="dt">&quot;skipLibCheck&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span><span id="cb9-9"><a href="#cb9-9"></a>    <span class="dt">&quot;forceConsistentCasingInFileNames&quot;</span><span class="fu">:</span> <span class="kw">true</span></span><span id="cb9-10"><a href="#cb9-10"></a>  <span class="fu">}</span></span><span id="cb9-11"><a href="#cb9-11"></a><span class="fu">}</span></span></code></pre></div><p><code>outDir</code> 指定 <code>tsc</code> 命令编译结果输出路径。</p><h2 id="编写代码">编写代码</h2><h3 id="使用-commander.js">使用 Commander.js</h3><p>要编写的是命令行工具，自然要解析命令行参数，出于不重复造轮子的目的选择 <a href="https://github.com/tj/commander.js" target="_blank" rel="noopener">Commander.js</a> 来解析命令行参数。</p><p>安装 Commander.js：</p><pre class="shell"><code>yarn add commander</code></pre><p>Commander.js 使用很简单，一个例子：</p><div class="sourceCode" id="cb11"><pre class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb11-1"><a href="#cb11-1"></a><span class="im">import</span> <span class="op">{</span> program <span class="op">}</span> <span class="im">from</span> <span class="st">&#39;commander&#39;</span><span class="op">;</span></span><span id="cb11-2"><a href="#cb11-2"></a></span><span id="cb11-3"><a href="#cb11-3"></a>program</span><span id="cb11-4"><a href="#cb11-4"></a>  .<span class="fu">version</span>(<span class="st">&#39;1.0.3&#39;</span>)</span><span id="cb11-5"><a href="#cb11-5"></a>  .<span class="fu">name</span>(<span class="st">&#39;upload-to-qiniu&#39;</span>)</span><span id="cb11-6"><a href="#cb11-6"></a>  .<span class="fu">requiredOption</span>(<span class="st">&#39;-a, --access-key [ak]&#39;</span><span class="op">,</span> <span class="st">&#39;access key&#39;</span>)</span><span id="cb11-7"><a href="#cb11-7"></a>  .<span class="fu">requiredOption</span>(<span class="st">&#39;-s, --secret-key [sk]&#39;</span><span class="op">,</span> <span class="st">&#39;secret key&#39;</span>)</span><span id="cb11-8"><a href="#cb11-8"></a>  .<span class="fu">option</span>(<span class="st">&#39;-d, --upload-dir &lt;dir&gt;&#39;</span><span class="op">,</span> <span class="st">&#39;要上传的目录&#39;</span><span class="op">,</span> <span class="st">&#39;./&#39;</span>)</span><span id="cb11-9"><a href="#cb11-9"></a>  .<span class="fu">requiredOption</span>(<span class="st">&#39;-b, --bucket [bucket]&#39;</span><span class="op">,</span> <span class="st">&#39;对象存储空间名&#39;</span>)</span><span id="cb11-10"><a href="#cb11-10"></a>  .<span class="fu">option</span>(<span class="st">&#39;-e, --exclude-prefix &lt;prefixs...&gt;&#39;</span><span class="op">,</span> <span class="st">&#39;忽略的文件名前缀，可以设置多个&#39;</span>)</span><span id="cb11-11"><a href="#cb11-11"></a>  .<span class="fu">parse</span>()<span class="op">;</span></span></code></pre></div><p><code>import { program } from 'commander';</code> 导入全局对象，<code>version</code> 指定版本号，<code>name</code> 指定 <code>-h</code> 帮助信息的名称。</p><p><code>option</code> 定义选项，一共三个参数：</p><ul><li>第一个参数指定选项名称，指定选项的短名称和长名称，使用逗号、空格或 <code>|</code> 分割，必选</li><li>第二个参数为选项描述，可选</li><li>第三个参数为默认值，可选</li></ul><p><code>option</code> 定义的选项是非必选的，如需要定义必选选项可以使用 <code>requiredOption</code>，如果使用命令行时没有指定必选选项会有报错。</p><p>有两种最常用的选项，一类是 boolean 型选项，选项无需配置参数，另一类选项则可以设置参数（使用尖括号声明）。如果在命令行中不指定具体的选项及参数，则会被定义为 <code>undefined</code>。</p><p>代码中将长名称转化成小驼峰来获取用户指定的参数值，例如：</p><div class="sourceCode" id="cb12"><pre class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">const</span> mac <span class="op">=</span> <span class="kw">new</span> <span class="va">qiniu</span><span class="op">.</span><span class="va">auth</span><span class="op">.</span><span class="va">digest</span><span class="op">.</span><span class="fu">Mac</span>(<span class="va">program</span><span class="op">.</span><span class="at">accessKey</span><span class="op">,</span> <span class="va">program</span><span class="op">.</span><span class="at">secretKey</span>)<span class="op">;</span></span></code></pre></div><p><code>program.accessKey</code> 获取的是 <code>-a</code> 参数指定的值。</p><p>定义好选项后可以使用 <code>-h</code> 查看帮助信息：</p><pre class="text"><code>&gt; upload-to-qiniu -hUsage: upload-to-qiniu [options]Options:  -V, --version                      output the version number  -a, --access-key [ak]              access key  -s, --secret-key [sk]              secret key  -d, --upload-dir &lt;dir&gt;             要上传的目录 (default: &quot;./&quot;)  -b, --bucket [bucket]              对象存储空间名  -e, --exclude-prefix &lt;prefixs...&gt;  忽略的文件名前缀，可以设置多个  -h, --help                         display help for command</code></pre><h3 id="编写逻辑代码">编写逻辑代码</h3><p>做了这么多准备终于可以正式开始编写代码了，在根目录创建 <code>src</code> 目录，然后在其中编写代码即可。</p><p>每个项目具体细节有很大差异，这里就不写具体细节了，不过有一点要注意，入口文件首行一定要加上 <code>#!/usr/bin/env node</code> 来指定解释器，否则会使用系统解释器，在 Windows 下不能正常使用。</p><p>本文涉及的具体代码可以在 <a href="https://github.com/Dreace/upload-to-qiniu" target="_blank" rel="noopener">Dreace/upload-to-qiniu</a> 找到。</p><h2 id="发布-npm-包">发布 npm 包</h2><h3 id="填写包信息">填写包信息</h3><div class="sourceCode" id="cb14"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">{</span></span><span id="cb14-2"><a href="#cb14-2"></a>  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;upload-to-qiniu&quot;</span><span class="fu">,</span></span><span id="cb14-3"><a href="#cb14-3"></a>  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0.4&quot;</span><span class="fu">,</span></span><span id="cb14-4"><a href="#cb14-4"></a>  <span class="dt">&quot;license&quot;</span><span class="fu">:</span> <span class="st">&quot;GPL-3.0&quot;</span><span class="fu">,</span></span><span id="cb14-5"><a href="#cb14-5"></a>  <span class="dt">&quot;main&quot;</span><span class="fu">:</span> <span class="st">&quot;dist/upload.js&quot;</span><span class="fu">,</span></span><span id="cb14-6"><a href="#cb14-6"></a>  <span class="dt">&quot;bin&quot;</span><span class="fu">:</span> <span class="fu">{</span></span><span id="cb14-7"><a href="#cb14-7"></a>    <span class="dt">&quot;upload-to-qiniu&quot;</span><span class="fu">:</span> <span class="st">&quot;dist/upload.js&quot;</span></span><span id="cb14-8"><a href="#cb14-8"></a>  <span class="fu">},</span></span><span id="cb14-9"><a href="#cb14-9"></a>  <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></span><span id="cb14-10"><a href="#cb14-10"></a>    <span class="dt">&quot;lint&quot;</span><span class="fu">:</span> <span class="st">&quot;eslint src --fix --ext .ts&quot;</span></span><span id="cb14-11"><a href="#cb14-11"></a>  <span class="fu">},</span></span><span id="cb14-12"><a href="#cb14-12"></a>  <span class="dt">&quot;files&quot;</span><span class="fu">:</span> <span class="ot">[</span></span><span id="cb14-13"><a href="#cb14-13"></a>    <span class="st">&quot;dist/**/*.js&quot;</span></span><span id="cb14-14"><a href="#cb14-14"></a>  <span class="ot">]</span><span class="fu">,</span></span><span id="cb14-15"><a href="#cb14-15"></a>  <span class="dt">&quot;dependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span></span><span id="cb14-16"><a href="#cb14-16"></a>    <span class="dt">&quot;commander&quot;</span><span class="fu">:</span> <span class="st">&quot;^6.0.0&quot;</span><span class="fu">,</span></span><span id="cb14-17"><a href="#cb14-17"></a>    <span class="dt">&quot;qiniu&quot;</span><span class="fu">:</span> <span class="st">&quot;^7.3.2&quot;</span></span><span id="cb14-18"><a href="#cb14-18"></a>  <span class="fu">},</span></span><span id="cb14-19"><a href="#cb14-19"></a>  <span class="dt">&quot;devDependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span></span><span id="cb14-20"><a href="#cb14-20"></a>    <span class="dt">&quot;@types/node&quot;</span><span class="fu">:</span> <span class="st">&quot;^14.0.24&quot;</span><span class="fu">,</span></span><span id="cb14-21"><a href="#cb14-21"></a>    <span class="dt">&quot;@typescript-eslint/eslint-plugin&quot;</span><span class="fu">:</span> <span class="st">&quot;^3.7.0&quot;</span><span class="fu">,</span></span><span id="cb14-22"><a href="#cb14-22"></a>    <span class="dt">&quot;@typescript-eslint/parser&quot;</span><span class="fu">:</span> <span class="st">&quot;^3.7.0&quot;</span><span class="fu">,</span></span><span id="cb14-23"><a href="#cb14-23"></a>    <span class="dt">&quot;eslint&quot;</span><span class="fu">:</span> <span class="st">&quot;^7.5.0&quot;</span><span class="fu">,</span></span><span id="cb14-24"><a href="#cb14-24"></a>    <span class="dt">&quot;eslint-plugin-prettier&quot;</span><span class="fu">:</span> <span class="st">&quot;^3.1.4&quot;</span><span class="fu">,</span></span><span id="cb14-25"><a href="#cb14-25"></a>    <span class="dt">&quot;prettier&quot;</span><span class="fu">:</span> <span class="st">&quot;^2.0.5&quot;</span></span><span id="cb14-26"><a href="#cb14-26"></a>  <span class="fu">}</span></span><span id="cb14-27"><a href="#cb14-27"></a><span class="fu">}</span></span></code></pre></div><p><code>name</code> 指定包名，在 npm 中全局唯一，<code>version</code> 指定当前版本，<code>license</code> 指定许可证。</p><p><code>bin</code> 指定命令行和要执行的 <code>.js</code> 脚本对应关系，一个包可以提供多个命令行工具。</p><p><code>files</code> 指定打包时要包含的文件，除此 <code>README.md</code> 和 <code>LICENSE</code> 也会被打包。</p><h3 id="本地测试">本地测试</h3><p>编写完代码后需要安装为全局包进行测试。</p><pre class="shell"><code>npm i -g .</code></pre><p>将当前目录下的文件安装为全局包，安装后可以通过 <code>bin</code> 中指定的名称来使用。</p><h3 id="发布">发布</h3><p>首先 <a href="https://www.npmjs.com/signup" target="_blank" rel="noopener">注册一个 npm 账号</a>。然后使用 <code>npm login</code> 登录到 npm。</p><p>登录后使用 <code>npm publish</code> 发布包，输出信息大致如下：</p><pre class="text"><code>&gt; npm publishnpm noticenpm notice package: upload-to-qiniu@1.0.5npm notice === Tarball Contents ===npm notice 35.8kB LICENSEnpm notice 6.0kB  dist/upload.jsnpm notice 6.6kB  dist/utils.jsnpm notice 931B   package.jsonnpm notice 1.0kB  README.mdnpm notice === Tarball Details ===npm notice name:          upload-to-qiniunpm notice version:       1.0.5npm notice package size:  16.4 kBnpm notice unpacked size: 50.4 kBnpm notice shasum:        73b867074f514761f6c6c9a442c38e83bc18aa9anpm notice integrity:     sha512-qHdhXhV/JjzMv[...]x6wD4OY1ysFnQ==npm notice total files:   5npm notice+ upload-to-qiniu@1.0.5</code></pre><p>发布成功后可以在 <a href="https://www.npmjs.com/" target="_blank" rel="noopener">https://www.npmjs.com/</a> 看到包信息。</p><section class="footnotes" role="doc-endnotes"><hr><ol><li id="fn1" role="doc-endnote"><p><a href="https://juejin.im/post/5ecdd5185188254329780b0f" target="_blank" rel="noopener">https://juejin.im/post/5ecdd5185188254329780b0f</a> "用 Node.js 写个命令行翻译工具, 发布到 npm"<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li><li id="fn2" role="doc-endnote"><p><a href="https://github.com/forthealllight/blog/issues/45" target="_blank" rel="noopener">https://github.com/forthealllight/blog/issues/45</a> "在Typescript项目中，如何优雅的使用ESLint和Prettier"<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li><li id="fn3" role="doc-endnote"><p><a href="https://ts.xcatliu.com/engineering/lint.html" target="_blank" rel="noopener">https://ts.xcatliu.com/engineering/lint.html</a> "代码检查 · TypeScript 入门教程"<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li></ol></section>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近在研究优化在国内访问静态博客的时间，其中有一个方案是将生成的文件存储在对象存储，然后再通过 CDN 回源对象存储。确定方案后使用 &lt;a href=&quot;https://www.qiniu.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;七牛云&lt;/a&gt; 做一个加速实验，由于要将生成的文件上传，又要将这个过程尽可能自动化，而七牛云只提供 SDK，要上传只能将密钥硬编码在代码中，这是很危险的。&lt;/p&gt;
&lt;p&gt;因此有了编写一个命令行工具的想法，由于最近在学习 TypeScript，就决定用它来写。&lt;/p&gt;
    
    </summary>
    
    
      <category term="TypeScript" scheme="https://blog.dreace.top/categories/TypeScript/"/>
    
    
      <category term="npm" scheme="https://blog.dreace.top/tags/npm/"/>
    
      <category term="TypeScript" scheme="https://blog.dreace.top/tags/TypeScript/"/>
    
  </entry>
  
  <entry>
    <title>TopK 问题两种解决方案：堆、快排变形</title>
    <link href="https://blog.dreace.top/2020/Two-Solutions-to-the-Topk-Problem-Heap-Quick-Sort/"/>
    <id>https://blog.dreace.top/2020/Two-Solutions-to-the-Topk-Problem-Heap-Quick-Sort/</id>
    <published>2020-07-10T04:31:47.000Z</published>
    <updated>2023-01-10T14:30:55.299Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css" integrity="sha384-dbVIfZGuN1Yq7/1Ocstc1lUEm+AT+/rCkibIcC/OmWo5f0EA48Vf8CytHzGrSwbQ" crossorigin="anonymous"><p>这里的 TopK 不单指最大的 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span> 个元素，也可以是最小的 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span> 个元素，具体的例题可以看 <a href="https://leetcode-cn.com/problems/zui-xiao-de-kge-shu-lcof/" target="_blank" rel="noopener">剑指 Offer 40. 最小的k个数</a>。本文的代码均为可以在力扣提交的题解，故不包含头文件和 <code>main</code> 函数。</p><a id="more"></a><h2 id="堆">堆</h2><p>看到这种题，最先想到的可能是直接使用已有的排序函数，但是其时间复杂度为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n \log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>，大量的排序工作是多余。</p><p>一个优化的想法是，建立一个大小为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span> 的堆（针对求最小的 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span> 个元素使用最大堆），只需要一次遍历将遍历到的元素和堆顶元素比较，若比堆顶小，则替换堆顶，然后进行堆调整。遍历完成后，堆中就是要求的最小的 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span> 个元素（无序的）。</p><p>通过堆优化后时间复杂度为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n \log k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span>。</p><div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">class</span> Solution {</span><span id="cb1-2"><a href="#cb1-2"></a><span class="kw">public</span>:</span><span id="cb1-3"><a href="#cb1-3"></a>    vector&lt;<span class="dt">int</span>&gt; getLeastNumbers(<span class="at">const</span> vector&lt;<span class="dt">int</span>&gt; &amp;arr, <span class="dt">int</span> k) {</span><span id="cb1-4"><a href="#cb1-4"></a>        vector&lt;<span class="dt">int</span>&gt; ans(k, <span class="dv">0</span>);</span><span id="cb1-5"><a href="#cb1-5"></a>        <span class="cf">if</span> (k == <span class="dv">0</span>) {</span><span id="cb1-6"><a href="#cb1-6"></a>            <span class="cf">return</span> ans;</span><span id="cb1-7"><a href="#cb1-7"></a>        }</span><span id="cb1-8"><a href="#cb1-8"></a>        <span class="co">// 建堆</span></span><span id="cb1-9"><a href="#cb1-9"></a>        <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; k; ++i) {</span><span id="cb1-10"><a href="#cb1-10"></a>            ans[i] = arr[i];</span><span id="cb1-11"><a href="#cb1-11"></a>        }</span><span id="cb1-12"><a href="#cb1-12"></a>        <span class="cf">for</span> (<span class="dt">int</span> i = k / <span class="dv">2</span> - <span class="dv">1</span>; i &gt;= <span class="dv">0</span>; --i) {</span><span id="cb1-13"><a href="#cb1-13"></a>            adjust(ans, i);</span><span id="cb1-14"><a href="#cb1-14"></a>        }</span><span id="cb1-15"><a href="#cb1-15"></a>        <span class="dt">int</span> n = arr.size();</span><span id="cb1-16"><a href="#cb1-16"></a>        <span class="cf">for</span> (<span class="dt">int</span> i = k; i &lt; n; ++i) {</span><span id="cb1-17"><a href="#cb1-17"></a>            <span class="co">// 比堆中最大的要小</span></span><span id="cb1-18"><a href="#cb1-18"></a>            <span class="cf">if</span> (arr[i] &lt; ans[<span class="dv">0</span>]) {</span><span id="cb1-19"><a href="#cb1-19"></a>                <span class="co">// 替换</span></span><span id="cb1-20"><a href="#cb1-20"></a>                ans[<span class="dv">0</span>] = arr[i];</span><span id="cb1-21"><a href="#cb1-21"></a>                <span class="co">// 调整后堆顶是最大的元素</span></span><span id="cb1-22"><a href="#cb1-22"></a>                adjust(ans, <span class="dv">0</span><span class="bu">u</span>);</span><span id="cb1-23"><a href="#cb1-23"></a>            }</span><span id="cb1-24"><a href="#cb1-24"></a>        }</span><span id="cb1-25"><a href="#cb1-25"></a>        <span class="cf">return</span> ans;</span><span id="cb1-26"><a href="#cb1-26"></a>    }</span><span id="cb1-27"><a href="#cb1-27"></a></span><span id="cb1-28"><a href="#cb1-28"></a></span><span id="cb1-29"><a href="#cb1-29"></a>    <span class="dt">void</span> adjust(vector&lt;<span class="dt">int</span>&gt; &amp;heap, <span class="dt">uint32_t</span> index) {</span><span id="cb1-30"><a href="#cb1-30"></a>        <span class="dt">uint32_t</span> t = index;</span><span id="cb1-31"><a href="#cb1-31"></a>        <span class="co">// 左孩子</span></span><span id="cb1-32"><a href="#cb1-32"></a>        <span class="cf">if</span> ((index &lt;&lt; <span class="dv">1</span><span class="bu">u</span>) + <span class="dv">1</span> &lt; heap.size() &amp;&amp; heap[(index &lt;&lt; <span class="dv">1</span><span class="bu">u</span>) + <span class="dv">1</span>] &gt; heap[t]) {</span><span id="cb1-33"><a href="#cb1-33"></a>            t = (index &lt;&lt; <span class="dv">1</span><span class="bu">u</span>) + <span class="dv">1</span>;</span><span id="cb1-34"><a href="#cb1-34"></a>        }</span><span id="cb1-35"><a href="#cb1-35"></a>        <span class="co">// 右孩子</span></span><span id="cb1-36"><a href="#cb1-36"></a>        <span class="cf">if</span> ((index &lt;&lt; <span class="dv">1</span><span class="bu">u</span>) + <span class="dv">2</span> &lt; heap.size() &amp;&amp; heap[(index &lt;&lt; <span class="dv">1</span><span class="bu">u</span>) + <span class="dv">2</span>] &gt; heap[t]) {</span><span id="cb1-37"><a href="#cb1-37"></a>            t = (index &lt;&lt; <span class="dv">1</span><span class="bu">u</span>) + <span class="dv">2</span>;</span><span id="cb1-38"><a href="#cb1-38"></a>        }</span><span id="cb1-39"><a href="#cb1-39"></a>        <span class="co">// 孩子节点比父节点大</span></span><span id="cb1-40"><a href="#cb1-40"></a>        <span class="cf">if</span> (t != index) {</span><span id="cb1-41"><a href="#cb1-41"></a>            <span class="bu">std::</span>swap(heap[index], heap[t]);</span><span id="cb1-42"><a href="#cb1-42"></a>            <span class="co">// 递归调整</span></span><span id="cb1-43"><a href="#cb1-43"></a>            adjust(heap, t);</span><span id="cb1-44"><a href="#cb1-44"></a>        }</span><span id="cb1-45"><a href="#cb1-45"></a>    }</span><span id="cb1-46"><a href="#cb1-46"></a>};</span></code></pre></div><h2 id="快排">快排</h2><p>这里不是真的快排，而是借助快排的思想，将元素划分成比中间元素后大或小的两部分后，再对其中的一个部分再次划分。快排的思想是分治，这里解决 TopK 的思想是减治，因为划分后不符合条件的部分直接舍弃掉。</p><p>该方法的期望时间复杂度 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>，最坏时间复杂度 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，因为可能每次选取的中间值都是最大值，为了解决这个问题，可以随机选择中间值（被注释掉的三行代码）。</p><div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">class</span> Solution {</span><span id="cb2-2"><a href="#cb2-2"></a><span class="kw">public</span>:</span><span id="cb2-3"><a href="#cb2-3"></a>    <span class="bu">std::</span>vector&lt;<span class="dt">int</span>&gt; getLeastNumbers(<span class="bu">std::</span>vector&lt;<span class="dt">int</span>&gt; &amp;arr, <span class="dt">int</span> k) {</span><span id="cb2-4"><a href="#cb2-4"></a>        <span class="dt">uint32_t</span> left = <span class="dv">0</span>, right = arr.size() - <span class="dv">1</span>;</span><span id="cb2-5"><a href="#cb2-5"></a><span class="co">//        srand(time(nullptr));</span></span><span id="cb2-6"><a href="#cb2-6"></a>        <span class="cf">while</span> (left &lt; right) {</span><span id="cb2-7"><a href="#cb2-7"></a><span class="co">//            int t = rand() % (right - left + 1) + left;</span></span><span id="cb2-8"><a href="#cb2-8"></a><span class="co">//            std::swap(arr[left], arr[t]);</span></span><span id="cb2-9"><a href="#cb2-9"></a>            <span class="dt">int</span> pivot = arr[left];</span><span id="cb2-10"><a href="#cb2-10"></a>            <span class="dt">int</span> i = left, j = right;</span><span id="cb2-11"><a href="#cb2-11"></a>            <span class="co">// 完成后以 i 为分界，左半部分比 arr[i] 小，右半部分比 arr[i] 大</span></span><span id="cb2-12"><a href="#cb2-12"></a>            <span class="cf">while</span> (i &lt;= j) {</span><span id="cb2-13"><a href="#cb2-13"></a>                <span class="co">// 寻找左半部分比 pivot 大的元素</span></span><span id="cb2-14"><a href="#cb2-14"></a>                <span class="cf">while</span> (i &lt;= j &amp;&amp; arr[i] &lt; pivot) {</span><span id="cb2-15"><a href="#cb2-15"></a>                    ++i;</span><span id="cb2-16"><a href="#cb2-16"></a>                }</span><span id="cb2-17"><a href="#cb2-17"></a>                <span class="co">// 寻找右半部分比 pivot 小的元素</span></span><span id="cb2-18"><a href="#cb2-18"></a>                <span class="cf">while</span> (i &lt;= j &amp;&amp; arr[j] &gt; pivot) {</span><span id="cb2-19"><a href="#cb2-19"></a>                    --j;</span><span id="cb2-20"><a href="#cb2-20"></a>                }</span><span id="cb2-21"><a href="#cb2-21"></a>                <span class="cf">if</span> (i &lt;= j) {</span><span id="cb2-22"><a href="#cb2-22"></a>                    <span class="bu">std::</span>swap(arr[i], arr[j]);</span><span id="cb2-23"><a href="#cb2-23"></a>                    ++i;</span><span id="cb2-24"><a href="#cb2-24"></a>                    --j;</span><span id="cb2-25"><a href="#cb2-25"></a>                }</span><span id="cb2-26"><a href="#cb2-26"></a>            }</span><span id="cb2-27"><a href="#cb2-27"></a>            <span class="cf">if</span> (i &gt;= k) {</span><span id="cb2-28"><a href="#cb2-28"></a>                <span class="co">// 大于等于 k 个</span></span><span id="cb2-29"><a href="#cb2-29"></a>                right = i - <span class="dv">1</span>;</span><span id="cb2-30"><a href="#cb2-30"></a>            } <span class="cf">else</span> {</span><span id="cb2-31"><a href="#cb2-31"></a>                <span class="co">// 小于 k 个</span></span><span id="cb2-32"><a href="#cb2-32"></a>                left = i;</span><span id="cb2-33"><a href="#cb2-33"></a>            }</span><span id="cb2-34"><a href="#cb2-34"></a>        }</span><span id="cb2-35"><a href="#cb2-35"></a>        <span class="cf">return</span> <span class="bu">std::</span>vector&lt;<span class="dt">int</span>&gt;(arr.begin(), arr.begin() + k);</span><span id="cb2-36"><a href="#cb2-36"></a>    }</span><span id="cb2-37"><a href="#cb2-37"></a>};</span></code></pre></div><h2 id="两种算法的选择">两种算法的选择</h2><p>在数据量比较小时，两个算法没有太大的区别。</p><p>但是当数据量达到十亿级别（腾讯面试被问过这个问题）使用快排需要将所有数据读入内存（当然也可以优化，但是会更复杂）。</p><p>而使用堆只需要维护一个大小为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span> 的堆（实际来说是数组），由于只需要遍历一次数据，数据读入一次就行了，对磁盘的操作可以很少。相比 CPU 的速度，磁盘 I/O 的时间有数量级上的差异。</p><p>因此在大数据量上应该选择堆。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这里的 TopK 不单指最大的 &lt;span class=&quot;math inline&quot;&gt;k&lt;/span&gt; 个元素，也可以是最小的 &lt;span class=&quot;math inline&quot;&gt;k&lt;/span&gt; 个元素，具体的例题可以看 &lt;a href=&quot;https://leetcode-cn.com/problems/zui-xiao-de-kge-shu-lcof/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;剑指 Offer 40. 最小的k个数&lt;/a&gt;。本文的代码均为可以在力扣提交的题解，故不包含头文件和 &lt;code&gt;main&lt;/code&gt; 函数。&lt;/p&gt;
    
    </summary>
    
    
      <category term="算法" scheme="https://blog.dreace.top/categories/%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="算法" scheme="https://blog.dreace.top/tags/%E7%AE%97%E6%B3%95/"/>
    
      <category term="C++" scheme="https://blog.dreace.top/tags/C/"/>
    
  </entry>
  
  <entry>
    <title>使用 Python 实现 DES 算法</title>
    <link href="https://blog.dreace.top/2020/Use-Python-to-implement-the-DES-algorithm/"/>
    <id>https://blog.dreace.top/2020/Use-Python-to-implement-the-DES-algorithm/</id>
    <published>2020-07-07T08:15:36.000Z</published>
    <updated>2023-01-10T14:30:55.299Z</updated>
    
    <content type="html"><![CDATA[<p>没有前言，直接进入正题，若需要关于 DES 的详细介绍，请看 <a href="https://zh.wikipedia.org/wiki/%E8%B3%87%E6%96%99%E5%8A%A0%E5%AF%86%E6%A8%99%E6%BA%96" target="_blank" rel="noopener">数据加密标准 - 维基百科，自由的百科全书</a>。若无特殊说明，本文章所有配图均来自维基百科。第一次使用工具函数时会进行详细介绍。本文章使用的全部代码可以在 <a href="https://gist.github.com/Dreace/4fc39e0ec2615ad06554e4ef9b9c64b6" target="_blank" rel="noopener">Gist</a> 上找到。</p><a id="more"></a><h2 id="子密钥生成">子密钥生成</h2><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/Use-Python-to-implement-the-DES-algorithm/250px-DES-key-schedule.png" alt><figcaption>子密钥生成过程</figcaption></figure><p>初始化时由外部提供密钥，若密钥长度不足 8 字节（64 位）可以在末尾使用 0 补足长度。</p><div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="cf">if</span> <span class="bu">isinstance</span>(key, <span class="bu">str</span>):</span><span id="cb1-2"><a href="#cb1-2"></a>    key <span class="op">=</span> key.encode()</span><span id="cb1-3"><a href="#cb1-3"></a><span class="cf">if</span> <span class="bu">len</span>(key) <span class="op">&gt;</span> <span class="dv">8</span>:</span><span id="cb1-4"><a href="#cb1-4"></a>    key <span class="op">=</span> key[<span class="dv">8</span>:]</span><span id="cb1-5"><a href="#cb1-5"></a><span class="cf">elif</span> <span class="bu">len</span>(key) <span class="op">&lt;</span> <span class="dv">8</span>:</span><span id="cb1-6"><a href="#cb1-6"></a>    key <span class="op">+=</span> b<span class="st">&quot;&quot;</span>.join(b<span class="st">&quot;</span><span class="ch">\x00</span><span class="st">&quot;</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">8</span> <span class="op">-</span> <span class="bu">len</span>(key)))</span><span id="cb1-7"><a href="#cb1-7"></a>key_bit_list <span class="op">=</span> <span class="va">self</span>._bytes_to_bit_list(key)</span></code></pre></div><p>提供的密钥可以是字符串或者是字节，若是字符串则需要编码得到字节，方便后续的处理，最后将长度裁剪或补足到 8 字节后转换成比特列表。字节到比特列表的函数如下：</p><div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">def</span> _bytes_to_bit_list(input_bytes: <span class="bu">bytes</span>) <span class="op">-&gt;</span> List[<span class="bu">int</span>]:</span><span id="cb2-2"><a href="#cb2-2"></a>    bit_list <span class="op">=</span> [<span class="dv">0</span>] <span class="op">*</span> <span class="dv">8</span> <span class="op">*</span> <span class="bu">len</span>(input_bytes)</span><span id="cb2-3"><a href="#cb2-3"></a>    index <span class="op">=</span> <span class="dv">0</span></span><span id="cb2-4"><a href="#cb2-4"></a>    <span class="cf">for</span> char_ascii <span class="kw">in</span> input_bytes:</span><span id="cb2-5"><a href="#cb2-5"></a>        loc <span class="op">=</span> <span class="dv">7</span></span><span id="cb2-6"><a href="#cb2-6"></a>        <span class="cf">while</span> loc <span class="op">&gt;=</span> <span class="dv">0</span>:</span><span id="cb2-7"><a href="#cb2-7"></a>            bit_list[index] <span class="op">=</span> <span class="dv">0</span> <span class="cf">if</span> char_ascii <span class="op">&amp;</span> (<span class="dv">1</span> <span class="op">&lt;&lt;</span> loc) <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">1</span></span><span id="cb2-8"><a href="#cb2-8"></a>            loc <span class="op">-=</span> <span class="dv">1</span></span><span id="cb2-9"><a href="#cb2-9"></a>            index <span class="op">+=</span> <span class="dv">1</span></span><span id="cb2-10"><a href="#cb2-10"></a>    <span class="cf">return</span> bit_list</span></code></pre></div><p>字节使用 <code>for</code> 得到的元素是数字，这里命名为 <code>char_ascii</code>，从高位到低位依次取出 <code>char_ascii</code> 的每一位填充到比特列表中。</p><p>得到密钥的比特列表后需要使用 PC-1 生成两个 28 位半密钥（总共只使用了 56 位密钥，剩下的 8 位可以作为奇偶校验）。</p><div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a>left_half_key_block <span class="op">=</span> <span class="va">self</span>._transform(key_bit_list, pc1_left_table)</span><span id="cb3-2"><a href="#cb3-2"></a>right_half_key_block <span class="op">=</span> <span class="va">self</span>._transform(key_bit_list, pc1_right_table)</span></code></pre></div><p>这里使用了一个置换工具函数，这个函数在 DES 算法中应该是最常用的了，通过查表进行变换。</p><div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">def</span> _transform(raw_list: <span class="bu">list</span>, transform_table: List[<span class="bu">int</span>]) <span class="op">-&gt;</span> <span class="bu">list</span>:</span><span id="cb4-2"><a href="#cb4-2"></a>    <span class="cf">return</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> index: raw_list[index], transform_table))</span></code></pre></div><p>在得到两个半密钥后下一步是生成 16 个子密钥，首先将两个半密钥循环左移（左移位数查表得）合并，再通过 PC-2 得到 48 位的子密钥。</p><div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a>sub_key_list <span class="op">=</span> []</span><span id="cb5-2"><a href="#cb5-2"></a><span class="cf">for</span> round_index <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">16</span>):</span><span id="cb5-3"><a href="#cb5-3"></a>    left_half_key_block <span class="op">=</span> <span class="va">self</span>._circle_left_shift(left_half_key_block, key_left_shift_bits[round_index])</span><span id="cb5-4"><a href="#cb5-4"></a>    right_half_key_block <span class="op">=</span> <span class="va">self</span>._circle_left_shift(right_half_key_block, key_left_shift_bits[round_index])</span><span id="cb5-5"><a href="#cb5-5"></a>    sub_key_list.append(<span class="va">self</span>._transform(left_half_key_block <span class="op">+</span> right_half_key_block, pc2_table))</span><span id="cb5-6"><a href="#cb5-6"></a><span class="va">self</span>._sub_key_list <span class="op">=</span> sub_key_list</span></code></pre></div><p><code>_circle_left_shift</code> 实现如下：</p><div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">def</span> _circle_left_shift(input_list: <span class="bu">list</span>, bits: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">list</span>:</span><span id="cb6-2"><a href="#cb6-2"></a>    <span class="cf">return</span> input_list[bits:] <span class="op">+</span> input_list[:bits]</span></code></pre></div><p>将输入列表切片再合并实现循环左移效果。</p><h2 id="分块加密">分块加密</h2><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/Use-Python-to-implement-the-DES-algorithm/250px-DES-main-network.png" alt><figcaption>整体结构</figcaption></figure><p>一次 DES 加密针对 64 位的明文，首先将明文进行 IP 后再分为两部分。</p><div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>plain_block <span class="op">=</span> <span class="va">self</span>._transform(plain_block, ip_table)</span><span id="cb7-2"><a href="#cb7-2"></a>left_half_block <span class="op">=</span> plain_block[:<span class="dv">32</span>]</span><span id="cb7-3"><a href="#cb7-3"></a>right_half_block <span class="op">=</span> plain_block[<span class="dv">32</span>:]</span></code></pre></div><p>将左半部分与右半部分经过 F 函数后的结果异或得到新的左半部分，原来的左半部分作为新的右半部分。如此进行十六次。</p><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/Use-Python-to-implement-the-DES-algorithm/250px-DES-f-function.png" alt><figcaption>F 函数</figcaption></figure><div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="cf">for</span> round_index <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">16</span>):</span><span id="cb8-2"><a href="#cb8-2"></a>    left_half_block, right_half_block <span class="op">=</span> right_half_block, <span class="op">\</span></span><span id="cb8-3"><a href="#cb8-3"></a>                                        <span class="va">self</span>._bit_list_xor(</span><span id="cb8-4"><a href="#cb8-4"></a>                                            left_half_block,</span><span id="cb8-5"><a href="#cb8-5"></a>                                            <span class="va">self</span>._transform(</span><span id="cb8-6"><a href="#cb8-6"></a>                                                <span class="va">self</span>._s_box_transform(</span><span id="cb8-7"><a href="#cb8-7"></a>                                                    <span class="va">self</span>._bit_list_xor(</span><span id="cb8-8"><a href="#cb8-8"></a>                                                        <span class="va">self</span>._transform(right_half_block,</span><span id="cb8-9"><a href="#cb8-9"></a>                                                                        extend_table),</span><span id="cb8-10"><a href="#cb8-10"></a>                                                        <span class="va">self</span>._sub_key_list[round_index]</span><span id="cb8-11"><a href="#cb8-11"></a>                                                    )</span><span id="cb8-12"><a href="#cb8-12"></a>                                                ), p_table</span><span id="cb8-13"><a href="#cb8-13"></a>                                            )</span><span id="cb8-14"><a href="#cb8-14"></a>                                        )</span><span id="cb8-15"><a href="#cb8-15"></a><span class="cf">return</span> <span class="va">self</span>._transform(right_half_block <span class="op">+</span> left_half_block, fp_table)</span></code></pre></div><p>F 函数的过程：</p><ol type="1"><li>通过扩张置换将 32 位的半块扩展到 48 位</li><li>与 48 位的子密钥进行异或</li><li>每 6 位进行 S 盒变换，得到 4 位的输出，共 32 位</li><li>最后再进行 P 置换</li></ol><p>这里涉及到一个比特列表的异或操作，实现如下：</p><div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">def</span> _bit_list_xor(left: <span class="bu">list</span>, right: <span class="bu">list</span>) <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span><span id="cb9-2"><a href="#cb9-2"></a>    <span class="cf">return</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> x, y: x <span class="op">^</span> y, left, right))</span></code></pre></div><p>和 S 盒变换工具函数：</p><div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">def</span> _s_box_transform(input_list: <span class="bu">list</span>) <span class="op">-&gt;</span> <span class="bu">list</span>:</span><span id="cb10-2"><a href="#cb10-2"></a>    transformed <span class="op">=</span> [<span class="dv">0</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">32</span>)]</span><span id="cb10-3"><a href="#cb10-3"></a>    transformed_index <span class="op">=</span> <span class="dv">0</span></span><span id="cb10-4"><a href="#cb10-4"></a>    r <span class="op">=</span> <span class="dv">0</span></span><span id="cb10-5"><a href="#cb10-5"></a>    <span class="cf">while</span> r <span class="op">&lt;</span> <span class="dv">48</span>:</span><span id="cb10-6"><a href="#cb10-6"></a>        m <span class="op">=</span> (input_list[r] <span class="op">&lt;&lt;</span> <span class="dv">1</span>) <span class="op">+</span> input_list[r <span class="op">+</span> <span class="dv">5</span>]</span><span id="cb10-7"><a href="#cb10-7"></a>        n <span class="op">=</span> (input_list[r <span class="op">+</span> <span class="dv">1</span>] <span class="op">&lt;&lt;</span> <span class="dv">3</span>) <span class="op">+</span> (input_list[r <span class="op">+</span> <span class="dv">2</span>] <span class="op">&lt;&lt;</span> <span class="dv">2</span>) <span class="op">+</span> (input_list[r <span class="op">+</span> <span class="dv">3</span>] <span class="op">&lt;&lt;</span> <span class="dv">1</span>) <span class="op">+</span> (input_list[r <span class="op">+</span> <span class="dv">4</span>])</span><span id="cb10-8"><a href="#cb10-8"></a>        s_value <span class="op">=</span> s_box_tables[r <span class="op">//</span> <span class="dv">6</span>][(m <span class="op">&lt;&lt;</span> <span class="dv">4</span>) <span class="op">+</span> n]</span><span id="cb10-9"><a href="#cb10-9"></a>        transformed[transformed_index] <span class="op">=</span> (s_value <span class="op">&amp;</span> <span class="dv">8</span>) <span class="op">&gt;&gt;</span> <span class="dv">3</span></span><span id="cb10-10"><a href="#cb10-10"></a>        transformed[transformed_index <span class="op">+</span> <span class="dv">1</span>] <span class="op">=</span> (s_value <span class="op">&amp;</span> <span class="dv">4</span>) <span class="op">&gt;&gt;</span> <span class="dv">2</span></span><span id="cb10-11"><a href="#cb10-11"></a>        transformed[transformed_index <span class="op">+</span> <span class="dv">2</span>] <span class="op">=</span> (s_value <span class="op">&amp;</span> <span class="dv">2</span>) <span class="op">&gt;&gt;</span> <span class="dv">1</span></span><span id="cb10-12"><a href="#cb10-12"></a>        transformed[transformed_index <span class="op">+</span> <span class="dv">3</span>] <span class="op">=</span> s_value <span class="op">&amp;</span> <span class="dv">1</span></span><span id="cb10-13"><a href="#cb10-13"></a>        r <span class="op">+=</span> <span class="dv">6</span></span><span id="cb10-14"><a href="#cb10-14"></a>        transformed_index <span class="op">+=</span> <span class="dv">4</span></span><span id="cb10-15"><a href="#cb10-15"></a>    <span class="cf">return</span> transformed</span></code></pre></div><p>每次取出 6 六位，最高位和最低位计算 <code>m</code> 为行号，中间四位计算 <code>n</code> 为列号。为了方便处理这里将二维的 S 盒表格展开为一维数组，根据 <code>m</code> 和 <code>n</code> 取出 S 盒中元素。</p><p>最后将元素转换成比特填充到 <code>transformed</code> 中。</p><h2 id="明文加密">明文加密</h2><p>加密函数接受字符串和字节作为参数，若明文长度不是 8 的整数倍字节则需要补足。</p><div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="cf">if</span> <span class="bu">isinstance</span>(plain_text, <span class="bu">str</span>):</span><span id="cb11-2"><a href="#cb11-2"></a>    plain_text <span class="op">=</span> plain_text.encode()</span><span id="cb11-3"><a href="#cb11-3"></a>plain_text_len <span class="op">=</span> <span class="bu">len</span>(plain_text)</span><span id="cb11-4"><a href="#cb11-4"></a><span class="cf">if</span> plain_text_len <span class="op">%</span> <span class="dv">8</span>:</span><span id="cb11-5"><a href="#cb11-5"></a>    plain_text <span class="op">+=</span> b<span class="st">&quot;&quot;</span>.join(b<span class="st">&quot;</span><span class="ch">\x00</span><span class="st">&quot;</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">8</span> <span class="op">-</span> plain_text_len <span class="op">%</span> <span class="dv">8</span>))</span></code></pre></div><p>将明文分成 8 字节长的块后分别进行加密，全部块加密完成后得到若干个 64 位长的比特列表，将这些列表合并，再转换成字节。</p><div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a>encrypted_blocks <span class="op">=</span> []</span><span id="cb12-2"><a href="#cb12-2"></a><span class="cf">for</span> block <span class="kw">in</span> <span class="bu">map</span>(<span class="kw">lambda</span> s: plain_text[s:s <span class="op">+</span> <span class="dv">8</span>], <span class="bu">range</span>(<span class="dv">0</span>, plain_text_len, <span class="dv">8</span>)):</span><span id="cb12-3"><a href="#cb12-3"></a>    encrypted_blocks.append(<span class="va">self</span>._encrypt_block(<span class="va">self</span>._bytes_to_bit_list(block)))</span><span id="cb12-4"><a href="#cb12-4"></a>encrypted_bit_list <span class="op">=</span> <span class="bu">list</span>(chain(<span class="op">*</span>encrypted_blocks))</span><span id="cb12-5"><a href="#cb12-5"></a><span class="cf">return</span> <span class="va">self</span>._bit_list_to_bytes(encrypted_bit_list)</span></code></pre></div><p>比特列表到字节函数如下：</p><div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">def</span> _bit_list_to_bytes(bit_list: List[<span class="bu">int</span>]) <span class="op">-&gt;</span> <span class="bu">bytes</span>:</span><span id="cb13-2"><a href="#cb13-2"></a>    char_ascii <span class="op">=</span> <span class="dv">0</span></span><span id="cb13-3"><a href="#cb13-3"></a>    byte_list <span class="op">=</span> []</span><span id="cb13-4"><a href="#cb13-4"></a>    <span class="cf">for</span> index, bit <span class="kw">in</span> <span class="bu">enumerate</span>(bit_list):</span><span id="cb13-5"><a href="#cb13-5"></a>        char_ascii <span class="op">+=</span> bit <span class="op">&lt;&lt;</span> (<span class="dv">7</span> <span class="op">-</span> index <span class="op">%</span> <span class="dv">8</span>)</span><span id="cb13-6"><a href="#cb13-6"></a>        <span class="cf">if</span> index <span class="op">%</span> <span class="dv">8</span> <span class="op">==</span> <span class="dv">7</span>:</span><span id="cb13-7"><a href="#cb13-7"></a>            byte_list.append(char_ascii)</span><span id="cb13-8"><a href="#cb13-8"></a>            char_ascii <span class="op">=</span> <span class="dv">0</span></span><span id="cb13-9"><a href="#cb13-9"></a>    <span class="cf">return</span> <span class="bu">bytes</span>(byte_list)</span></code></pre></div><h2 id="解密">解密</h2><p>解密过程和加密过程完全相同，只不过子密钥使用顺序相反。</p><div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">def</span> decrypt(<span class="va">self</span>, cipher_text: <span class="bu">bytes</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span><span id="cb14-2"><a href="#cb14-2"></a>    <span class="va">self</span>._sub_key_list.reverse()</span><span id="cb14-3"><a href="#cb14-3"></a>    plain_text <span class="op">=</span> <span class="va">self</span>.encrypt(cipher_text)</span><span id="cb14-4"><a href="#cb14-4"></a>    <span class="va">self</span>._sub_key_list.reverse()</span><span id="cb14-5"><a href="#cb14-5"></a>    <span class="cf">return</span> plain_text.decode().rstrip(<span class="st">&#39;</span><span class="ch">\0</span><span class="st">&#39;</span>)</span></code></pre></div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;没有前言，直接进入正题，若需要关于 DES 的详细介绍，请看 &lt;a href=&quot;https://zh.wikipedia.org/wiki/%E8%B3%87%E6%96%99%E5%8A%A0%E5%AF%86%E6%A8%99%E6%BA%96&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;数据加密标准 - 维基百科，自由的百科全书&lt;/a&gt;。若无特殊说明，本文章所有配图均来自维基百科。第一次使用工具函数时会进行详细介绍。本文章使用的全部代码可以在 &lt;a href=&quot;https://gist.github.com/Dreace/4fc39e0ec2615ad06554e4ef9b9c64b6&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Gist&lt;/a&gt; 上找到。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python" scheme="https://blog.dreace.top/categories/Python/"/>
    
    
      <category term="Python" scheme="https://blog.dreace.top/tags/Python/"/>
    
      <category term="DES" scheme="https://blog.dreace.top/tags/DES/"/>
    
  </entry>
  
  <entry>
    <title>解决 Clion 无法识别 WSL Ubuntu 20.04 LTS</title>
    <link href="https://blog.dreace.top/2020/Solved-that-Clion-Does-not-recognize-WSL-Ubuntu-20-04-LTS/"/>
    <id>https://blog.dreace.top/2020/Solved-that-Clion-Does-not-recognize-WSL-Ubuntu-20-04-LTS/</id>
    <published>2020-05-10T13:23:16.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p><strong>注：本文提到的 WSL 均为 WSL 1。</strong></p><p>最近在学网络编程，需要在 Linux 下编译 C 源码，可我日常使用 Windows，在虚拟机里操作又不是很方便。于是 Clion + WSL 成了几乎完美的解决方案，在 Windows 下编码，Linux 环境下编译运行。</p><p>但是由于一个意外需要卸载已安装的 WSL（Ubuntu 18.04 LTS），凑巧巨硬最近发布了 Ubuntu 20.04 LTS 的 WSL，于是尝试了一下。尴尬的是最新版本的 Clion 还不能识别 20.04，但问题不大。</p><a id="more"></a><h2 id="修改配置文件">修改配置文件</h2><p>原本 Clion 应能识别已安装的 WSL，但 20.04 的设置还未添加，故不能识别。解决办法很简答，手动添加即可。打开 <code>C:\Users\&lt;用户名&gt;\AppData\Roaming\JetBrains\CLion&lt;版本号&gt;\options\wsl.distributions.xml</code>，在 <code>set</code> 下添加<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>：</p><div class="sourceCode" id="cb1"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">&lt;descriptor&gt;</span></span><span id="cb1-2"><a href="#cb1-2"></a>    <span class="kw">&lt;id&gt;</span>UBUNTU2004<span class="kw">&lt;/id&gt;</span></span><span id="cb1-3"><a href="#cb1-3"></a>    <span class="kw">&lt;microsoft-id&gt;</span>Ubuntu-20.04<span class="kw">&lt;/microsoft-id&gt;</span></span><span id="cb1-4"><a href="#cb1-4"></a>    <span class="kw">&lt;executable-path&gt;</span>ubuntu2004.exe<span class="kw">&lt;/executable-path&gt;</span></span><span id="cb1-5"><a href="#cb1-5"></a>    <span class="kw">&lt;presentable-name&gt;</span>Ubuntu 20.04<span class="kw">&lt;/presentable-name&gt;</span></span><span id="cb1-6"><a href="#cb1-6"></a><span class="kw">&lt;/descriptor&gt;</span></span></code></pre></div><p>保存，重启 Clion 即可。</p><h2 id="再解决一个问题">再解决一个问题</h2><p>在升级 20.04 的包时遇到 <code>sleep: cannot read realtime clock: Invalid argument</code> 错误，应该是一个 WSL 的 bug，据说已经在 Windows 2004 修复，但是 2004 要还没正式发布。目前的解决办法是降级导致问题的 <code>libc6</code> 包<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>：</p><div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">wget</span> <span class="st">&quot;https://launchpad.net/~rafaeldtinoco/+archive/ubuntu/lp1871129/+build/19152555/+files/libc6_2.31-0ubuntu8+lp1871129~1_amd64.deb&quot;</span></span><span id="cb2-2"><a href="#cb2-2"></a><span class="fu">sudo</span> dpkg -i libc6_2.31-0ubuntu8+lp1871129~1_amd64.deb</span></code></pre></div><p>在升级前将其版本冻结：</p><div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">apt-mark</span> hold libc6</span></code></pre></div><p>这样该问题可以解决。但是降级会导致 gcc、cmake 等一大票编译工具<strong>无法</strong>正常安装。</p><h2 id="最后">最后</h2><p>还是回到了 Ubuntu 18.04 LTS。</p><section class="footnotes" role="doc-endnotes"><hr><ol><li id="fn1" role="doc-endnote"><p><a href="https://intellij-support.jetbrains.com/hc/en-us/community/posts/360004135320-CLion-not-picking-up-WSL" target="_blank" rel="noopener">https://intellij-support.jetbrains.com/hc/en-us/community/posts/360004135320-CLion-not-picking-up-WSL</a> "CLion not picking up WSL – IDEs Support (IntelliJ Platform) | JetBrains"<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li><li id="fn2" role="doc-endnote"><p><a href="https://github.com/microsoft/WSL/issues/4898" target="_blank" rel="noopener">https://github.com/microsoft/WSL/issues/4898</a> "[WSL1] [glibc] sleep: cannot read realtime clock: Invalid argument"<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li></ol></section>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;注：本文提到的 WSL 均为 WSL 1。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;最近在学网络编程，需要在 Linux 下编译 C 源码，可我日常使用 Windows，在虚拟机里操作又不是很方便。于是 Clion + WSL 成了几乎完美的解决方案，在 Windows 下编码，Linux 环境下编译运行。&lt;/p&gt;
&lt;p&gt;但是由于一个意外需要卸载已安装的 WSL（Ubuntu 18.04 LTS），凑巧巨硬最近发布了 Ubuntu 20.04 LTS 的 WSL，于是尝试了一下。尴尬的是最新版本的 Clion 还不能识别 20.04，但问题不大。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://blog.dreace.top/categories/Linux/"/>
    
    
      <category term="Clion" scheme="https://blog.dreace.top/tags/Clion/"/>
    
      <category term="Ubuntu" scheme="https://blog.dreace.top/tags/Ubuntu/"/>
    
      <category term="WSL" scheme="https://blog.dreace.top/tags/WSL/"/>
    
  </entry>
  
  <entry>
    <title>InfluxDB 内存优化</title>
    <link href="https://blog.dreace.top/2020/InfluxDB-Memory-Optimization/"/>
    <id>https://blog.dreace.top/2020/InfluxDB-Memory-Optimization/</id>
    <published>2020-05-08T03:27:20.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p>最近给小程序的后端日志加上了实时输出到前端功能，为了展示就得保存日志，又考虑到日志是时序数据，自然就选择了时序数据库 <a href="https://www.influxdata.com/" target="_blank" rel="noopener">InfluxDB</a>，并且通过 Docker 部署。刚上线的一两天没有什么问题，各方面运行都很平稳，没过几天的一个早上突然收到了阿里云的报警，说内存占用超过了 95%。</p><p>这便是噩梦的开始。</p><a id="more"></a><h2 id="罪魁祸首">罪魁祸首</h2><p>收到报警后看了一下系统各项指标，不仅内存占用高，CPU、磁盘使用率都是满负荷。</p><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/InfluxDB-Memory-Optimization/image-20200508120656188.png" alt><figcaption>报警时系统指标</figcaption></figure><p>在凌晨一点半左右内存暴涨，紧接着 CPU 使用率也达到 100%。这个场景似曾相识，因为之前使用过 InfluxDB，也遇到过内存暴涨，结合前几天又用上了 InfluxDB，基本可以断定是 InfluxDB 的锅。</p><p>重启服务器后一切都恢复正常，但是 InfluxDB 可能随时又出现状况，只能一直盯着各种指标，盯数据的时候发现 InfluxDB 的内存占用肉眼可见地增长，可以说很恐怖了。</p><h2 id="尝试解决">尝试解决</h2><p>好在 InfluxDB 是通过 Docker 部署的，可以很方便地限制内存使用，尝试通过 <code>docker-compose.yml</code> 配置：</p><div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">deploy</span><span class="kw">:</span></span><span id="cb1-2"><a href="#cb1-2"></a><span class="at">    </span><span class="fu">resources</span><span class="kw">:</span></span><span id="cb1-3"><a href="#cb1-3"></a><span class="at">    </span><span class="fu">limits</span><span class="kw">:</span></span><span id="cb1-4"><a href="#cb1-4"></a><span class="at">        </span><span class="fu">memory</span><span class="kw">:</span><span class="at"> 500M</span></span><span id="cb1-5"><a href="#cb1-5"></a><span class="fu">restart</span><span class="kw">:</span><span class="at"> always</span></span></code></pre></div><p>将 InfluxDB 可以使用的内存限制在 500MiB，超过这个数值就会被 kill，然后又自动重启。虽然这样可以避免 InfluxDB 将系统拖垮，但频繁 OOM 又重启终究不是什么好办法。</p><h3 id="更改索引方式">更改索引方式</h3><p>查了一些资料后得知 InfluxDB 默认的索引是在内存上维护的，不断地数据增长会使用越来越多的内存，并有一个参数 <code>index-version</code> 可以设置索引方式<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。如果是直接在主机上部署的可以修改配置文件，Docker 部署则需要通过环境变量设置：</p><div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">environment</span><span class="kw">:</span></span><span id="cb2-2"><a href="#cb2-2"></a><span class="at">    </span><span class="fu">INFLUXDB_DATA_INDEX_VERSION</span><span class="kw">:</span><span class="at"> tsi1</span></span></code></pre></div><p>将索引数据存储在磁盘上，可以通过日志或者查看分片的目录结构验证修改是否生效，若索引方式为 <code>tsi1</code>，在分片目录下会有一个名为 <code>index</code> 的目录，<code>inmem</code> 索引则没有。</p><p>具体位置是 <code>/var/lib/influxdb/data/&lt;数据库&gt;/&lt;保留策略&gt;/&lt;分片&gt;</code>。</p><pre class="text"><code>[root@izuf6czs1dw6siz3zokdiez 1_day]# ls1  10  11  12  13  14  15  16  18  19  20  21  3  4  5  6  7  8  9[root@izuf6czs1dw6siz3zokdiez 1_day]# cd 15[root@izuf6czs1dw6siz3zokdiez 15]# ls000000001-000000001.tsm  fields.idx  index</code></pre><h3 id="禁用状态监控">禁用状态监控</h3><p>默认情况下 InfluxDB 会维护一个 <code>_internal</code> 库，来监控系统状态，但是会产生不必要的数据，官方<strong>不推荐</strong>在生产环境下使用 <code>_internal</code> 库<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>。</p><blockquote><p>InfluxData does <strong>not</strong> recommend using the <code>_internal</code> database in a production cluster. It creates unnecessary overhead, particularly for busy clusters, that can overload an already loaded cluster. Metrics stored in the <code>_internal</code> database primarily measure workload performance and should only be tested in non-production environments.</p></blockquote><p>添加环境变量：</p><div class="sourceCode" id="cb4"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">environment</span><span class="kw">:</span></span><span id="cb4-2"><a href="#cb4-2"></a><span class="at">    </span><span class="fu">INFLUXDB_DATA_INDEX_VERSION</span><span class="kw">:</span><span class="at"> tsi1</span></span><span id="cb4-3"><a href="#cb4-3"></a><span class="at">    </span><span class="fu">INFLUXDB_MONITOR_STORE_ENABLED</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;false&quot;</span></span></code></pre></div><h2 id="效果验证">效果验证</h2><p><del>更改索引方式后内存使用依然在缓慢增长，但是保留策略设置的是一天，需要等到更改生效一天后才能看出真实的效果（待更新）。</del></p><p>超过保留策略（24 小时）的时间后（27 小时）内存增长停止，目前稳定在 235.3MiB，大致符合预期。</p><section class="footnotes" role="doc-endnotes"><hr><ol><li id="fn1" role="doc-endnote"><p><a href="https://www.jianshu.com/p/dbbb73b537e1" target="_blank" rel="noopener">https://www.jianshu.com/p/dbbb73b537e1</a> "InfluxDB频繁OOM问题排查 - 简书"<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li><li id="fn2" role="doc-endnote"><p><a href="https://docs.influxdata.com/platform/monitoring/influxdata-platform/tools/measurements-internal/" target="_blank" rel="noopener">https://docs.influxdata.com/platform/monitoring/influxdata-platform/tools/measurements-internal/</a> "InfluxDB _internal measurements and fields"<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li></ol></section>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近给小程序的后端日志加上了实时输出到前端功能，为了展示就得保存日志，又考虑到日志是时序数据，自然就选择了时序数据库 &lt;a href=&quot;https://www.influxdata.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;InfluxDB&lt;/a&gt;，并且通过 Docker 部署。刚上线的一两天没有什么问题，各方面运行都很平稳，没过几天的一个早上突然收到了阿里云的报警，说内存占用超过了 95%。&lt;/p&gt;
&lt;p&gt;这便是噩梦的开始。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Docker" scheme="https://blog.dreace.top/categories/Docker/"/>
    
    
      <category term="Linux" scheme="https://blog.dreace.top/tags/Linux/"/>
    
      <category term="Docker" scheme="https://blog.dreace.top/tags/Docker/"/>
    
      <category term="InfluxDB" scheme="https://blog.dreace.top/tags/InfluxDB/"/>
    
  </entry>
  
  <entry>
    <title>Windows 上 DNS 解析慢，但 nslookup 正常</title>
    <link href="https://blog.dreace.top/2020/DNS-Resolution-is-Slow-on-Windows-but-nslookup-is-Normal/"/>
    <id>https://blog.dreace.top/2020/DNS-Resolution-is-Slow-on-Windows-but-nslookup-is-Normal/</id>
    <published>2020-04-15T09:54:12.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p>今天一大早开始在电脑上所有的网站打开变得极慢，通过 SSH 连接服务器也非常慢，但 IP 直连速度又是正常的。初步猜测是 DNS 问题。</p><a id="more"></a><h2 id="定位问题">定位问题</h2><p>随后用 ping 测试发现需要好几秒钟才能解析出 IP，而用 nslookup 测试解析速度又是正常的。这下子基本知道问题了，又是系统 DNS 服务的锅，为什么是<strong>又</strong>呢？因为之前系统 DNS 服务把一些域名解析到了教育网，导致一些网站 CSS 加载失败，加了 hosts 之后才勉强正常。前一次的问题影响不是很大，可这次就不一样了，所有的网站打开都要等几秒钟，这可忍不了。</p><p>这里说一下为什么通过 ping 和 nslookup 就能断定系统 DNS 服务有问题呢，因为 ping 在解析域名时用的时系统 DNS 服务，而 nslookup 是直接通过 <a href="https://zh.wikipedia.org/wiki/Winsock" target="_blank" rel="noopener">Winsock</a> 建立连接查询的<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。</p><p>用 <a href="https://www.wireshark.org/" target="_blank" rel="noopener">Wireshark</a> 抓包发现使用 ping 时 DNS 查询报文也是很快响应了的，但是 ping 客户端似乎没有收到。到这里就陷入死胡同了，我对 Windows 内部的细节不了解，不能再往下定位问题。</p><h2 id="解决问题">解决问题</h2><p>由于上午事情比较多就暂时把这个问题放下了。</p><p>到了下午突然想起会不会又是 <a href="https://www.vmware.com/" target="_blank" rel="noopener">VMware</a> 虚拟网卡的问题，这里又是一个<strong>又</strong>😫，因为之前遇到过虚拟网卡导致移动热点 IP 冲突问题。尝试禁用以 <code>VMware Virtual Ethernet Adapter</code> 开头的网卡，再次测试，ping 和打开网页都已正常。</p><h2 id="后记">后记</h2><p>这次虽然解决了问题，但是具体原因还不清楚，日后搞清楚问题再更新这篇文章</p><section class="footnotes" role="doc-endnotes"><hr><ol><li id="fn1" role="doc-endnote"><p><a href="https://superuser.com/questions/495759/why-is-ping-unable-to-resolve-a-name-when-nslookup-works-fine" target="_blank" rel="noopener">https://superuser.com/questions/495759/why-is-ping-unable-to-resolve-a-name-when-nslookup-works-fine</a> "Why is 'ping' unable to resolve a name when 'nslookup' works fine?"<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li></ol></section>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;今天一大早开始在电脑上所有的网站打开变得极慢，通过 SSH 连接服务器也非常慢，但 IP 直连速度又是正常的。初步猜测是 DNS 问题。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Windows" scheme="https://blog.dreace.top/categories/Windows/"/>
    
    
      <category term="DNS" scheme="https://blog.dreace.top/tags/DNS/"/>
    
      <category term="Windows" scheme="https://blog.dreace.top/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>MySQL 多关键词匹配</title>
    <link href="https://blog.dreace.top/2020/MySQL-Multiple-Keyword-Matching/"/>
    <id>https://blog.dreace.top/2020/MySQL-Multiple-Keyword-Matching/</id>
    <published>2020-03-20T08:47:09.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p>在 MySQL 中像搜索引擎一样查找多个关键词只使用 <code>LIKE</code> 实现比较困难，如果硬写也可以拼接很长的 SQL 实现，但有点太暴力了。因此需要一个简洁的方法来实现这个需求，这就是这篇文章要探讨的问题。</p><a id="more"></a><h2 id="分析">分析</h2><p>使用搜索引擎可以搜索使用空格分割的多个关键词，例如 <code>Python MySQL 回滚</code> 能够搜索到同时包含这个三个关键词的结果，并且是顺序无关的。要是用 <code>LIKE</code> 来进行模糊匹配就要拼接一个又臭又长的 SQL，这个可能并不是我们想要的，除了 <code>LIKE</code> 还有什么好的办法呢。正则表达式！用正则表达式可以很容易实现这个需求。</p><p>既然有了办法开始写代码，首先考虑如何根据搜索输入 <code>Python MySQL 回滚</code> 匹配下面的字符串：</p><div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a>Python 中回滚 MySQL 操作。</span></code></pre></div><p>这个字符串中关键词输入顺序和输入的关键词顺序不同，但是顺序对结果不会产生影响。为了同时匹配多个关键词可以先拆分为多个独立的关键词分开匹配，若前一个成功则继续匹配知道所有关键词都成功匹配。</p><p>我们可以使用正则中的零宽先行断言（<code>(?=exp)</code>）<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>，它可以匹配以 <code>exp</code> 为后缀的字符串，之后的匹配将从 <code>exp</code> 前一个位置继续。</p><p>如果写成 <code>(?=.*exp)</code>，它将从后向前匹配以 <code>exp</code> 为后缀的字符串，若匹配式中包含多个零宽先行断言每一次匹配都从最后开始。</p><p>这样关键问题已解决，对于 <code>Python MySQL 回滚</code> 完整的表达式为：</p><div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a>(?<span class="op">=</span>.<span class="op">*</span>Python)(?<span class="op">=</span>.<span class="op">*</span>MySQL)(?<span class="op">=</span>.<span class="op">*</span>回滚)</span></code></pre></div><p>上面这个正则表达式可以判断一个字符串是否包含这三个关键词，若要提取成功匹配的字符串可以写成：</p><div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a>(?<span class="op">=</span>.<span class="op">*</span>Python)(?<span class="op">=</span>.<span class="op">*</span>MySQL)(?<span class="op">=</span>.<span class="op">*</span>回滚)<span class="op">^</span>.<span class="op">*</span>$</span></code></pre></div><h2 id="代码实现">代码实现</h2><p>下面写一个用正则在 MySQL 中进行多关键词查找的实例。</p><p>假设有一张表，结构如下：</p><pre><code>CREATE TABLE `课程-2020-1`  (  `教学班编号` varchar(32) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,  `学院` varchar(50) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,  `课程名` varchar(255) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,  `教师` varchar(25) CHARACTER SET utf8 COLLATE utf8_bin NULL DEFAULT NULL,  `周次` varchar(20) CHARACTER SET utf8 COLLATE utf8_bin NULL DEFAULT NULL,  `星期` int(11) NOT NULL,  `开始节次` int(11) NULL DEFAULT NULL,  `时长节次` int(11) NULL DEFAULT NULL,  `教学楼` varchar(50) CHARACTER SET utf8 COLLATE utf8_bin NULL DEFAULT NULL,  `教室` varchar(50) CHARACTER SET utf8 COLLATE utf8_bin NULL DEFAULT NULL,  PRIMARY KEY (`教学班编号`, `课程名`, `星期`) USING BTREE) ENGINE = InnoDB CHARACTER SET = utf8 COLLATE = utf8_bin ROW_FORMAT = Dynamic;</code></pre><p>我们希望能够同时匹配 <code>学院</code>、 <code>课程名</code>、<code>教师</code>三个字段中的值，例如输入 <code>工程 数据</code>，能够同时查找出「大数据学院」的「物联网工程技术基础」 和「信息与通信工程学院」的「大数据与云计算」课程，对应的 SQL 如下：</p><pre><code>SELECT * FROM `课程-2020-1` WHERE CONCAT_WS(&#39;&#39;, `学院`, `课程名`, `教师`) REGEXP &#39;(?=.*工程)(?=.*数据)&#39;</code></pre><p>其中 <code>CONCAT_WS('', `学院`, `课程名`, `教师`)</code> 将每行中 <code>学院</code>、 <code>课程名</code>、<code>教师</code> 字段的值连接形成一个字符串，第一个参数作为剩余参数间的分隔符<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>，<code>CONCAT_WS</code> 的作用类似 Python 和 JavaScript 中的 <code>join</code>。这里不使用 <code>CONCAT</code> 是因为 <code>教师</code> 字段可能为空值，进而导致 <code>CONCAT</code> 的返回结果也为空， 而 <code>CONCAT_WS</code> 会忽略空值。</p><p>搜索结果为：</p><figure><img class="lazyload" src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="/images/MySQL-Multiple-Keyword-Matching/image-20200320183837050.png" alt><figcaption>关键词"工程 数据"的搜索结果</figcaption></figure><p>完美实现！下面是输入关键词字符串生成对应 SQL 的 Python 代码：</p><pre><code>keywords_map = &quot;&quot;.join(map(lambda k: &quot;(?=.*%s)&quot; % k, keywords.split(&quot; &quot;)))sql = &quot;SELECT * FROM `课程-2020-1` WHERE CONCAT_WS(&#39;&#39;, `学院`, `课程名`, `教师`) REGEXP &#39;%s^.*$&#39;&quot; % keywords_map</code></pre><section class="footnotes" role="doc-endnotes"><hr><ol><li id="fn1" role="doc-endnote"><p><a href="https://www.cnblogs.com/symbol441/articles/957950.html" target="_blank" rel="noopener">https://www.cnblogs.com/symbol441/articles/957950.html</a> "正则表达式的分组"<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li><li id="fn2" role="doc-endnote"><p><a href="https://www.cnblogs.com/locoy/archive/2006/10/28/542751.html" target="_blank" rel="noopener">https://www.cnblogs.com/locoy/archive/2006/10/28/542751.html</a> "CONCAT_WS的用法"<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li></ol></section>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在 MySQL 中像搜索引擎一样查找多个关键词只使用 &lt;code&gt;LIKE&lt;/code&gt; 实现比较困难，如果硬写也可以拼接很长的 SQL 实现，但有点太暴力了。因此需要一个简洁的方法来实现这个需求，这就是这篇文章要探讨的问题。&lt;/p&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="https://blog.dreace.top/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://blog.dreace.top/tags/MySQL/"/>
    
      <category term="数据库" scheme="https://blog.dreace.top/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="SQL" scheme="https://blog.dreace.top/tags/SQL/"/>
    
      <category term="正则表达式" scheme="https://blog.dreace.top/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>解决“由于系统缓冲区空间不足或队列已满，不能执行套接字上的操作”</title>
    <link href="https://blog.dreace.top/2020/Solve-An-operation-on-a-socket-could-not-be-performed-because-the-system-lacked-sufficient-buffer-space-or-because-a-queue-was-full/"/>
    <id>https://blog.dreace.top/2020/Solve-An-operation-on-a-socket-could-not-be-performed-because-the-system-lacked-sufficient-buffer-space-or-because-a-queue-was-full/</id>
    <published>2020-02-21T11:05:53.000Z</published>
    <updated>2023-01-10T14:30:55.295Z</updated>
    
    <content type="html"><![CDATA[<p>最近写了个小工具，需要往 MySQL 中快速写入数据（5000 条数据左右）。刚开始很正常，跑了几分钟后报了一个错误 <code>由于系统缓冲区空间不足或队列已满，不能执行套接字上的操作</code>，这个问题以前也遇到过，只是通过简单的重启解决。虽然这次也通过重启把系统恢复正常了，可数据还没写到数据库里呢，于是花了点事件把这个问题彻底解决。</p><a id="more"></a><h2 id="问题分析">问题分析</h2><p>从报错的字面意思就能看出来系统的 Socket 资源耗尽无法建立新的链接。经查询得知 Windows 10 中默认允许用户使用的端口数是 1500，并且端口关闭后需要经过 60 秒才能重新被使用<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。查看数据库已写入的数据在 1600 条左右，和 1500 这个限制比较接近，由此问题被大致定位。</p><h2 id="解决问题">解决问题</h2><p>既然已经知道问题的根本原因，解决方法也呼之欲出：修改限制。在“注册表编辑器中”找到 <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters</code>。，修改 <code>MaxUserPort</code> 的值为 <code>65534</code>（十进制）或 <code>fffe</code>（十六进制）。同时也可以修改端口关闭后可重新使用的等待时间，在相同位置新建一个 <code>DWORD</code> 类型名称为 <code>TcpTimedWaitDelay</code> 的项目，其值表示等待多少秒后端口可以被重新使用。</p><p>完成之后重启。</p><p>再次运行，问题已经解决。</p><section class="footnotes" role="doc-endnotes"><hr><ol><li id="fn1" role="doc-endnote"><p><a href="https://support.microsoft.com/en-us/help/196271/when-you-try-to-connect-from-tcp-ports-greater-than-5000-you-receive-t" target="_blank" rel="noopener">https://support.microsoft.com/en-us/help/196271/when-you-try-to-connect-from-tcp-ports-greater-than-5000-you-receive-t</a> "When you try to connect from TCP ports greater than 5000 you receive the error 'WSAENOBUFS (10055)'"<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li></ol></section>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近写了个小工具，需要往 MySQL 中快速写入数据（5000 条数据左右）。刚开始很正常，跑了几分钟后报了一个错误 &lt;code&gt;由于系统缓冲区空间不足或队列已满，不能执行套接字上的操作&lt;/code&gt;，这个问题以前也遇到过，只是通过简单的重启解决。虽然这次也通过重启把系统恢复正常了，可数据还没写到数据库里呢，于是花了点事件把这个问题彻底解决。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Windows" scheme="https://blog.dreace.top/categories/Windows/"/>
    
    
      <category term="Windows" scheme="https://blog.dreace.top/tags/Windows/"/>
    
      <category term="注册表" scheme="https://blog.dreace.top/tags/%E6%B3%A8%E5%86%8C%E8%A1%A8/"/>
    
  </entry>
  
</feed>
